<!DOCTYPE html>
<html lang="es" class="{{ 'dark' if session.get('theme') == 'dark' else '' }}">
<head>
  <meta charset="utf-8"/>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
  <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Roboto:wght@300;400;500;700;900&family=Roboto+Mono:wght@400;500;700" onload="this.rel='stylesheet'" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <title>{% block title %}Weigence{% endblock %}</title>
  <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>

  <!-- CSS global -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/ia-recommendation.css') }}?v=10.1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/chat-float.css') }}">

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Weigence - Sistema de Gesti√≥n de Inventario y Ventas"/>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta name="current-user" content="{{ session.get('usuario_nombre', 'None') }}">
  <meta name="author" content="Weigence Team"/>
  <meta name="usuario_id" content="{{ session.get('usuario_id') }}">
  <!-- Tema dark/light -->
  <script>
    (function () {
      try {
        var storedTheme = localStorage.getItem('theme');
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        var shouldUseDark = storedTheme ? storedTheme === 'dark' : prefersDark;

        if (shouldUseDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      } catch (error) {
        console.error('Error applying theme:', error);
      }
    })();
  </script>

  <!-- Datos de usuario para JS (sin romper Jinja) -->
  <script>
    window.CURRENT_USER = {
      id: "{{ session.get('usuario_id') }}",
      nombre: "{{ session.get('usuario_nombre') }}",
      rol: "{{ session.get('usuario_rol', '---') }}"
    };
  </script>
</head>

<body class="!bg-[var(--bg-light)] dark:!bg-[var(--theme-bg-dark)] text-[var(--text-light)] font-[Inter,'Noto Sans',sans-serif]">
  <div class="flex min-h-screen w-full overflow-hidden">
    <!-- Sidebar -->
    {% block sidebar %}{% endblock %}

    <!-- Contenedor derecho -->
    <div class="flex flex-col flex-1 min-w-0 lg:pl-64">
      <!-- Header -->
      <header class="sticky top-0 z-40 bg-[var(--bg-light)] dark:bg-[var(--theme-bg-dark)] border-b border-[var(--border-light)] dark:border-[var(--border-dark)] shadow-soft">
        {% block top %}{% endblock %}
      </header>

      <!-- Contenido -->
      <main class="flex-1 px-2 sm:px-4 py-4 sm:py-8 overflow-y-auto overflow-x-hidden relative z-10">
        {% block contenido %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Variables globales -->
  <script>
    window.CATEGORIA_ESTANTES = {{ categoria_estantes | default({}) | tojson }};
  </script>
  <script>
    {% if movimientos is defined %}
      window.MOVIMIENTOS = {{ movimientos|tojson }};
    {% else %}
      window.MOVIMIENTOS = [];
    {% endif %}
  </script>

  <!-- JS global -->
  <script src="{{ url_for('static', filename='js/recomendaciones.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/ventas.js') }}"></script>
  <script src="{{ url_for('static', filename='js/script.js') }}"></script>
  <script src="{{ url_for('static', filename='js/historial.js') }}"></script>
  <script src="{{ url_for('static', filename='js/header.js') }}"></script>
  <script src="{{ url_for('static', filename='js/inventario.js') }}"></script>
  <script src="{{ url_for('static', filename='js/movimiento_inventario.js') }}"></script>
  <script src="{{ url_for('static', filename='js/estado.js') }}"></script>
  <script src="{{ url_for('static', filename='js/filtro.js') }}"></script>
  <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
  <script src="{{ url_for('static', filename='js/notificaciones.js') }}"></script>
  <!-- chart.js CDN ya est√° arriba, se mantiene por compatibilidad -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="{{ url_for('static', filename='js/auditoria-new.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ia-icons.js') }}"></script>
  <script src="{{ url_for('static', filename='js/edit-profile-modal.js') }}"></script>

  <!-- Heartbeat GLOBAL (sin Jinja dentro de template literals) -->
  {% if session.get('usuario_logueado') %}
  <script>
    function enviarHeartbeatGlobal() {
      const ahora = new Date().toLocaleTimeString();
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

      fetch('/api/usuarios/heartbeat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => {
        console.log('[HEARTBEAT-GLOBAL] üì° Respuesta recibida:', response.status);
        return response.json();
      })
      .then(data => {
        if (data.success) {
          console.log(
            `[HEARTBEAT-GLOBAL] ‚úì [${ahora}] Heartbeat confirmado - ` +
            `Usuario: ${window.CURRENT_USER.nombre} (${window.CURRENT_USER.id}) - ` +
            `Total conectados: ${data.total_conectados}`
          );
        } else {
          console.error('[HEARTBEAT-GLOBAL] ‚ùå Error en respuesta:', data);
        }
      })
      .catch(error => {
        console.error('[HEARTBEAT-GLOBAL] ‚ùå Error de red:', error);
      });
    }

    console.log('[HEARTBEAT-GLOBAL] üöÄ Iniciando sistema de rastreo...');
    console.log(
      `[HEARTBEAT-GLOBAL] üë§ Usuario actual: ${window.CURRENT_USER.nombre} (${window.CURRENT_USER.id})`
    );

    enviarHeartbeatGlobal();
    const heartbeatInterval = setInterval(enviarHeartbeatGlobal, 15000);
    console.log('[HEARTBEAT-GLOBAL] ‚è∞ Intervalo configurado: cada 15 segundos');

    window.addEventListener('beforeunload', function() {
      enviarHeartbeatGlobal();
      clearInterval(heartbeatInterval);
    });
  </script>
  {% else %}
  <script>
    console.log('[HEARTBEAT-GLOBAL] ‚ö†Ô∏è Usuario no autenticado, heartbeat deshabilitado');
  </script>
  {% endif %}
  
  <!-- Chat flotante: include + scripts -->
  {% if session.get("usuario_id") %}
    {% include "componentes/chat.html" %}


    <script src="{{ url_for('static', filename='js/chat/chat-float.js') }}"></script>

  {% endif %}
</body>
</html>
