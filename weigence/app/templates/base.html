<!DOCTYPE html>
<html lang="es" class="{{ 'dark' if session.get('theme') == 'dark' else '' }}">
<head>
  <meta charset="utf-8"/>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
  <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Roboto:wght@300;400;500;700;900&family=Roboto+Mono:wght@400;500;700" onload="this.rel='stylesheet'" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <title>{% block title %}Weigence{% endblock %}</title>
  <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/ia-recommendation.css') }}">
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Weigence - Sistema de Gesti√≥n de Inventario y Ventas"/>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta name="current-user" content="{{ session.get('usuario_nombre', 'None') }}">
    <script>
    (function () {
      try {
        var storedTheme = localStorage.getItem('theme');
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        var shouldUseDark = storedTheme ? storedTheme === 'dark' : prefersDark;

        if (shouldUseDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      } catch (error) {
        console.error('Error applying theme:', error);
      }
    })();
  </script>
  <meta name="author" content="Weigence Team"/>
</head>
<body class="!bg-[var(--bg-light)] dark:!bg-[var(--theme-bg-dark)] text-[var(--text-light)] font-[Inter,'Noto Sans',sans-serif]">
  <div class="flex min-h-screen w-full overflow-hidden ">
    <!-- Sidebar -->
    {% block sidebar %}{% endblock %}

  <!-- Contenedor derecho -->
  <div class="flex flex-col flex-1 min-w-0 pl-64">
      <!-- Header -->
      <header class="sticky top-0 z-50 bg-[var(--bg-light)] dark:bg-[var(--theme-bg-dark)] border-b border-[var(--border-light)] dark:border-[var(--border-dark)] shadow-soft">
        {% block top %}{% endblock %}
      </header>

      <!-- Contenido -->
      <main class="flex-1 px-4 py-8 overflow-y-auto overflow-x-hidden">
        {% block contenido %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Scripts -->
    <script>
      window.CATEGORIA_ESTANTES = {{ categoria_estantes | default({}) | tojson }};
    </script>
    <script>
      {% if movimientos is defined %}
        window.MOVIMIENTOS = {{ movimientos|tojson }};
      {% else %}
        window.MOVIMIENTOS = [];
      {% endif %}
    </script>
    <script src="{{ url_for('static', filename='js/recomendaciones.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/ventas.js') }}"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/historial.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script src="{{ url_for('static', filename='js/inventario.js') }}"></script>
    <script src="{{ url_for('static', filename='js/movimiento_inventario.js') }}"></script>
    <script src="{{ url_for('static', filename='js/estado.js') }}"></script>
    <script src="{{ url_for('static', filename='js/filtro.js') }}"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"> </script>
    <script src="{{ url_for('static', filename='js/notificaciones.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Script de Auditor√≠a -->
    <script src="{{ url_for('static', filename='js/auditoria.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ia-icons.js') }}"></script>
    <script src="{{ url_for('static', filename='js/edit-profile-modal.js') }}"></script>
    
    <!-- Script global de heartbeat para rastrear usuarios conectados -->
    <script>
      // Enviar heartbeat cada 15 segundos para indicar que el usuario est√° conectado
      {% if session.get('usuario_logueado') %}
      function enviarHeartbeatGlobal() {
        const ahora = new Date().toLocaleTimeString();
        fetch('/api/usuarios/heartbeat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
          console.log('[HEARTBEAT-GLOBAL] üì° Respuesta recibida:', response.status);
          return response.json();
        })
        .then(data => {
          if (data.success) {
            console.log(`[HEARTBEAT-GLOBAL] ‚úì [${ahora}] Heartbeat confirmado - Usuario: {{ session.get("usuario_nombre") }} ({{ session.get("usuario_id") }}) - Total conectados: ${data.total_conectados}`);
          } else {
            console.error('[HEARTBEAT-GLOBAL] ‚ùå Error en respuesta:', data);
          }
        })
        .catch(error => {
          console.error('[HEARTBEAT-GLOBAL] ‚ùå Error de red:', error);
        });
      }
      
      // Enviar inmediatamente al cargar la p√°gina
      console.log('[HEARTBEAT-GLOBAL] üöÄ Iniciando sistema de rastreo...');
      console.log('[HEARTBEAT-GLOBAL] üë§ Usuario actual: {{ session.get("usuario_nombre") }} ({{ session.get("usuario_id") }})');
      enviarHeartbeatGlobal();
      
      // Enviar cada 15 segundos
      const heartbeatInterval = setInterval(enviarHeartbeatGlobal, 15000);
      console.log('[HEARTBEAT-GLOBAL] ‚è∞ Intervalo configurado: cada 15 segundos');
      
      // Enviar heartbeat antes de cerrar/recargar la p√°gina
      window.addEventListener('beforeunload', function() {
        enviarHeartbeatGlobal();
      });
      {% else %}
      console.log('[HEARTBEAT-GLOBAL] ‚ö†Ô∏è Usuario no autenticado, heartbeat deshabilitado');
      {% endif %}
    </script>
    
    <!-- Bloque para scripts espec√≠ficos de cada p√°gina -->
    {% block scripts %}{% endblock %}

  <!-- Modal de edici√≥n de perfil -->
  {% include 'componentes/edit_profile_modal.html' %}

</body>
</html>
