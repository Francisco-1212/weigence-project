<!DOCTYPE html>
<html lang="es" class="{{ 'dark' if session.get('theme') == 'dark' else '' }}">
<head>
  <meta charset="utf-8"/>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
  <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Roboto:wght@300;400;500;700;900&family=Roboto+Mono:wght@400;500;700" onload="this.rel='stylesheet'" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <title>{% block title %}Weigence{% endblock %}</title>
  <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/ia-recommendation.css') }}?v=10.1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/chat-float.css') }}">
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Weigence - Sistema de Gesti√≥n de Inventario y Ventas"/>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta name="current-user" content="{{ session.get('usuario_nombre', 'None') }}">
    <script>
    (function () {
      try {
        var storedTheme = localStorage.getItem('theme');
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        var shouldUseDark = storedTheme ? storedTheme === 'dark' : prefersDark;

        if (shouldUseDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      } catch (error) {
        console.error('Error applying theme:', error);
      }
    })();
  </script>
  <meta name="author" content="Weigence Team"/>
</head>
<body class="!bg-[var(--bg-light)] dark:!bg-[var(--theme-bg-dark)] text-[var(--text-light)] font-[Inter,'Noto Sans',sans-serif]">
  <div class="flex min-h-screen w-full overflow-hidden">
    <!-- Sidebar -->
    {% block sidebar %}{% endblock %}

  <!-- Contenedor derecho -->
  <div class="flex flex-col flex-1 min-w-0 lg:pl-64">
      <!-- Header -->
      <header class="sticky top-0 z-40 bg-[var(--bg-light)] dark:bg-[var(--theme-bg-dark)] border-b border-[var(--border-light)] dark:border-[var(--border-dark)] shadow-soft">
        {% block top %}{% endblock %}
      </header>

      <!-- Contenido -->
      <main class="flex-1 px-2 sm:px-4 py-4 sm:py-8 overflow-y-auto overflow-x-hidden relative z-10">
        {% block contenido %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Scripts -->
    <script>
      window.CATEGORIA_ESTANTES = {{ categoria_estantes | default({}) | tojson }};
    </script>
    <script>
      {% if movimientos is defined %}
        window.MOVIMIENTOS = {{ movimientos|tojson }};
      {% else %}
        window.MOVIMIENTOS = [];
      {% endif %}
    </script>
    <script src="{{ url_for('static', filename='js/recomendaciones.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/ventas.js') }}"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/historial.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script src="{{ url_for('static', filename='js/inventario.js') }}"></script>
    <script src="{{ url_for('static', filename='js/movimiento_inventario.js') }}"></script>
    <script src="{{ url_for('static', filename='js/estado.js') }}"></script>
    <script src="{{ url_for('static', filename='js/filtro.js') }}"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"> </script>
    <script src="{{ url_for('static', filename='js/notificaciones.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Script de Auditor√≠a Modularizado -->
    <script type="module" src="{{ url_for('static', filename='js/auditoria-new.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ia-icons.js') }}"></script>
    <script src="{{ url_for('static', filename='js/edit-profile-modal.js') }}"></script>
    
    <!-- Script global de heartbeat para rastrear usuarios conectados -->
    <script>
      // Enviar heartbeat cada 15 segundos para indicar que el usuario est√° conectado
      {% if session.get('usuario_logueado') %}
      function enviarHeartbeatGlobal() {
        const ahora = new Date().toLocaleTimeString();
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
        fetch('/api/usuarios/heartbeat', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          }
        })
        .then(response => {
          console.log('[HEARTBEAT-GLOBAL] üì° Respuesta recibida:', response.status);
          return response.json();
        })
        .then(data => {
          if (data.success) {
            console.log(`[HEARTBEAT-GLOBAL] ‚úì [${ahora}] Heartbeat confirmado - Usuario: {{ session.get("usuario_nombre") }} ({{ session.get("usuario_id") }}) - Total conectados: ${data.total_conectados}`);
          } else {
            console.error('[HEARTBEAT-GLOBAL] ‚ùå Error en respuesta:', data);
          }
        })
        .catch(error => {
          console.error('[HEARTBEAT-GLOBAL] ‚ùå Error de red:', error);
        });
      }
      
      // Enviar inmediatamente al cargar la p√°gina
      console.log('[HEARTBEAT-GLOBAL] üöÄ Iniciando sistema de rastreo...');
      console.log('[HEARTBEAT-GLOBAL] üë§ Usuario actual: {{ session.get("usuario_nombre") }} ({{ session.get("usuario_id") }})');
      enviarHeartbeatGlobal();
      
      // Enviar cada 15 segundos
      const heartbeatInterval = setInterval(enviarHeartbeatGlobal, 15000);
      console.log('[HEARTBEAT-GLOBAL] ‚è∞ Intervalo configurado: cada 15 segundos');
      
      // Enviar heartbeat antes de cerrar/recargar la p√°gina
      window.addEventListener('beforeunload', function() {
        enviarHeartbeatGlobal();
      });
      {% else %}
      console.log('[HEARTBEAT-GLOBAL] ‚ö†Ô∏è Usuario no autenticado, heartbeat deshabilitado');
      {% endif %}
    </script>
    
    <!-- Bloque para scripts espec√≠ficos de cada p√°gina -->
    {% block scripts %}{% endblock %}

  <!-- Modal de edici√≥n de perfil -->
  {% include 'componentes/edit_profile_modal.html' %}

  <!-- Bot√≥n flotante de chat (estilo redes sociales) -->
  {% if session.get('usuario_logueado') %}
  <div id="chat-float-container" class="fixed bottom-6 right-6 z-[60] flex flex-col items-end gap-3">
    <!-- Mini panel de chat (oculto por defecto) -->
    <div id="chat-mini-panel" class="hidden w-[90vw] sm:w-96 h-[600px] max-h-[80vh] bg-white dark:bg-neutral-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-neutral-700 flex flex-col overflow-hidden animate-slide-up">
      <!-- Header mini chat -->
      <div class="p-4 bg-[var(--primary-color)] text-white flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button id="back-to-users" class="hidden p-1 hover:bg-white/20 rounded-lg transition-colors">
            <span class="material-symbols-outlined text-xl">arrow_back</span>
          </button>
          <span class="material-symbols-outlined">chat</span>
          <h3 class="font-bold" id="mini-chat-title">Equipo Weigence</h3>
        </div>
        <div class="flex items-center gap-2">
          <a href="{{ url_for('main.chat_page_route') }}" target="_blank" class="p-1 hover:bg-white/20 rounded-lg transition-colors" title="Abrir chat completo">
            <span class="material-symbols-outlined text-xl">open_in_new</span>
          </a>
          <button id="close-mini-chat" class="p-1 hover:bg-white/20 rounded-lg transition-colors">
            <span class="material-symbols-outlined text-xl">close</span>
          </button>
        </div>
      </div>
      
      <!-- Vista de usuarios -->
      <div id="mini-usuarios-container">
        <!-- B√∫squeda -->
        <div class="p-3 border-b border-gray-200 dark:border-neutral-700">
          <div class="relative">
            <input 
              type="text" 
              id="buscar-usuario-mini" 
              placeholder="Buscar persona..."
              class="w-full pl-9 pr-3 py-2 rounded-lg border border-gray-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]"
            >
            <span class="material-symbols-outlined absolute left-2.5 top-2 text-neutral-400 text-xl">search</span>
          </div>
        </div>
        
        <!-- Lista de usuarios -->
        <div id="mini-chat-usuarios" class="flex-1 overflow-y-auto p-2" style="max-height: 490px;">
          <div class="flex items-center justify-center h-full text-neutral-500 dark:text-neutral-400">
            <div class="text-center">
              <span class="material-symbols-outlined text-4xl mb-2 opacity-50">sync</span>
              <p class="text-sm">Cargando usuarios...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista de chat -->
      <div id="mini-chat-container" class="hidden flex-1 flex flex-col">
        <!-- Mensajes -->
        <div id="mini-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">
          <div class="flex items-center justify-center h-full text-neutral-500 dark:text-neutral-400">
            <p class="text-sm">Cargando mensajes...</p>
          </div>
        </div>
        
        <!-- Input de mensaje -->
        <div class="p-3 border-t border-gray-200 dark:border-neutral-700">
          <div class="flex gap-2">
            <input 
              type="text" 
              id="mini-chat-input" 
              placeholder="Escribe un mensaje..."
              class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]"
            >
            <button id="mini-chat-send" class="px-4 py-2 bg-[var(--primary-color)] hover:bg-[var(--primary-600)] text-white rounded-lg transition-colors">
              <span class="material-symbols-outlined text-xl">send</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bot√≥n flotante principal -->
    <button id="chat-float-btn" class="w-14 h-14 sm:w-16 sm:h-16 bg-[var(--primary-color)] hover:bg-[var(--primary-600)] text-white rounded-full shadow-lg hover:shadow-2xl transition-all duration-300 flex items-center justify-center group relative hover:scale-110">
      <span class="material-symbols-outlined text-2xl sm:text-3xl transition-transform" id="chat-icon">chat</span>
      <!-- Badge de mensajes no le√≠dos -->
      <span id="chat-float-badge" class="hidden absolute -top-1 -right-1 w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center animate-pulse border-2 border-white">
        0
      </span>
      <!-- Tooltip -->
      <span class="absolute right-full mr-3 px-3 py-2 bg-neutral-900 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
        Abrir chat
      </span>
    </button>
  </div>

  <!-- Script modularizado del chat flotante -->
  <script src="{{ url_for('static', filename='js/chat-float.js') }}"></script>
  {% endif %}

</body>
</html>
