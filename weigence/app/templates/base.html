
<!DOCTYPE html>
<html lang="es" class="{{ 'dark' if session.get('theme') == 'dark' else '' }}">
<head>
  <meta charset="utf-8"/>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
  <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Roboto:wght@300;400;500;700;900&family=Roboto+Mono:wght@400;500;700" onload="this.rel='stylesheet'" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <title>{% block title %}Weigence{% endblock %}</title>
  <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- CSS global (debe ir DESPU√âS de Tailwind CDN para evitar sobre-escritura) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/ia-recommendation.css') }}?v=10.1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/chat-float.css') }}">
  <script src="{{ url_for('static', filename='js/audit-detail-modal.js') }}" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Weigence - Sistema de Gesti√≥n de Inventario y Ventas"/>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta name="current-user" content="{{ session.get('usuario_nombre', 'None') }}">
  <meta name="author" content="Weigence Team"/>
  <meta name="usuario_id" content="{{ session.get('usuario_id') }}">
  <!-- Prevenir cach√© de la p√°gina -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- Tema dark/light -->
  <script>
    (function () {
      try {
        var storedTheme = localStorage.getItem('theme');
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        var shouldUseDark = storedTheme ? storedTheme === 'dark' : prefersDark;

        if (shouldUseDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      } catch (error) {
        console.error('Error applying theme:', error);
      }
    })();
  </script>

  <!-- Datos de usuario para JS (sin romper Jinja) -->
  <script>
    window.CURRENT_USER = {
      id: "{{ session.get('usuario_id') }}",
      nombre: "{{ session.get('usuario_nombre') }}",
      rol: "{{ session.get('usuario_rol', '---') }}"
    };
  </script>

  <!-- Seguridad: Prevenir navegaci√≥n hacia atr√°s despu√©s de logout -->
  <script>
    (function() {
      'use strict';
      
      // Funci√≥n para verificar sesi√≥n contra el servidor
      async function verificarSesionServidor() {
        try {
          const response = await fetch('/api/validate-session', {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
              'Cache-Control': 'no-cache'
            }
          });
          const data = await response.json();
          return data.valid === true;
        } catch (error) {
          console.error('[SECURITY] Error verificando sesi√≥n:', error);
          return false;
        }
      }
      
      // Validar sesi√≥n inmediatamente al cargar
      function validarSesionLocal() {
        const tieneUsuario = window.CURRENT_USER && window.CURRENT_USER.id && window.CURRENT_USER.id !== '';
        
        if (!tieneUsuario) {
          console.warn('[SECURITY] Sin sesi√≥n v√°lida - redirigiendo a login');
          window.location.replace("{{ url_for('main.login') }}");
          return false;
        }
        return true;
      }

      // Ejecutar validaci√≥n local inmediatamente
      if (!validarSesionLocal()) {
        return;
      }

      // Detectar navegaci√≥n desde cach√© (botones atr√°s/adelante)
      var esNavegacionCache = false;
      if (window.performance) {
        const navEntries = performance.getEntriesByType('navigation');
        if (navEntries.length > 0) {
          const navType = navEntries[0].type;
          if (navType === 'back_forward') {
            esNavegacionCache = true;
            console.log('[SECURITY] Navegaci√≥n back/forward detectada');
          }
        }
      }

      // Prevenir navegaci√≥n hacia atr√°s despu√©s de logout
      function prevenirRetroceso() {
        window.history.pushState(null, document.title, window.location.href);
      }
      
      prevenirRetroceso();

      // Interceptar bot√≥n atr√°s y adelante
      window.addEventListener('popstate', function(event) {
        console.log('[SECURITY] Evento popstate detectado');
        prevenirRetroceso();
        // NO recargar la p√°gina autom√°ticamente
      });

      // Detectar p√°gina desde cach√© (bfcache) - Chrome espec√≠fico
      window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
          console.log('[SECURITY] P√°gina restaurada desde bfcache');
          // Solo verificar sesi√≥n local, no forzar recarga
          if (!validarSesionLocal()) {
            window.location.replace("{{ url_for('main.login') }}");
          }
        }
      });

      // Prevenir cach√© al salir
      window.addEventListener('beforeunload', function() {
        if (window.CURRENT_USER && window.CURRENT_USER.id) {
          sessionStorage.setItem('lastPage', window.location.pathname);
        }
      });

    })();
  </script>
</head>

<body class="!bg-[var(--bg-light)] dark:!bg-[var(--theme-bg-dark)] text-[var(--text-light)] font-[Inter,'Noto Sans',sans-serif]">
  <div class="flex min-h-screen w-full overflow-hidden">
    <!-- Sidebar -->
    {% block sidebar %}{% endblock %}

    <!-- Contenedor derecho -->
    <div class="flex flex-col flex-1 min-w-0 lg:pl-64">
      <!-- Header -->
      <header class="sticky top-0 z-40 bg-[var(--bg-light)] dark:bg-[var(--theme-bg-dark)] border-b border-[var(--border-light)] dark:border-[var(--border-dark)] shadow-soft">
        {% block top %}{% endblock %}
      </header>

      <!-- Contenido -->
      <main class="flex-1 px-2 sm:px-4 py-4 sm:py-8 overflow-y-auto overflow-x-hidden relative z-10">
        {% block contenido %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Variables globales -->
  <script>
    window.CATEGORIA_ESTANTES = {{ categoria_estantes | default({}) | tojson }};
  </script>
  <script>
    {% if movimientos is defined %}
      window.MOVIMIENTOS = {{ movimientos|tojson }};
    {% else %}
      window.MOVIMIENTOS = [];
    {% endif %}
  </script>

  <!-- JS global -->
  <!-- Error Logger debe cargarse primero para estar disponible en todos los m√≥dulos -->
  <script src="{{ url_for('static', filename='js/error-logger.js') }}"></script>
  <script src="{{ url_for('static', filename='js/recomendaciones.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/ventas.js') }}"></script>
  <script src="{{ url_for('static', filename='js/script.js') }}"></script>
  <script src="{{ url_for('static', filename='js/historial.js') }}"></script>
  <script src="{{ url_for('static', filename='js/header.js') }}"></script>
  <script src="{{ url_for('static', filename='js/inventario.js') }}"></script>
  <script src="{{ url_for('static', filename='js/movimiento_inventario.js') }}"></script>
  <script src="{{ url_for('static', filename='js/estado.js') }}"></script>
  <script src="{{ url_for('static', filename='js/filtro.js') }}"></script>
  <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
  <script src="{{ url_for('static', filename='js/notificaciones.js') }}"></script>
  <!-- chart.js CDN ya est√° arriba, se mantiene por compatibilidad -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="{{ url_for('static', filename='js/auditoria-new.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ia-icons.js') }}"></script>
  <script src="{{ url_for('static', filename='js/edit-profile-modal.js') }}"></script>

  <!-- Heartbeat GLOBAL (sin Jinja dentro de template literals) -->
  {% if session.get('usuario_logueado') %}
  <script>
    function enviarHeartbeatGlobal() {
      const ahora = new Date().toLocaleTimeString();
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

      fetch('/api/usuarios/heartbeat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => {
        console.log('[HEARTBEAT-GLOBAL] üì° Respuesta recibida:', response.status);
        return response.json();
      })
      .then(data => {
        if (data.success) {
          console.log(
            `[HEARTBEAT-GLOBAL] ‚úì [${ahora}] Heartbeat confirmado - ` +
            `Usuario: ${window.CURRENT_USER.nombre} (${window.CURRENT_USER.id}) - ` +
            `Total conectados: ${data.total_conectados}`
          );
        } else {
          console.error('[HEARTBEAT-GLOBAL] ‚ùå Error en respuesta:', data);
        }
      })
      .catch(error => {
        console.error('[HEARTBEAT-GLOBAL] ‚ùå Error de red:', error);
      });
    }

    console.log('[HEARTBEAT-GLOBAL] üöÄ Iniciando sistema de rastreo...');
    console.log(
      `[HEARTBEAT-GLOBAL] üë§ Usuario actual: ${window.CURRENT_USER.nombre} (${window.CURRENT_USER.id})`
    );

    enviarHeartbeatGlobal();
    const heartbeatInterval = setInterval(enviarHeartbeatGlobal, 15000);
    console.log('[HEARTBEAT-GLOBAL] ‚è∞ Intervalo configurado: cada 15 segundos');

    window.addEventListener('beforeunload', function() {
      enviarHeartbeatGlobal();
      clearInterval(heartbeatInterval);
    });
  </script>
  {% else %}
  <script>
    console.log('[HEARTBEAT-GLOBAL] ‚ö†Ô∏è Usuario no autenticado, heartbeat deshabilitado');
  </script>
  {% endif %}
  
  <!-- Modal de editar perfil -->
  {% if session.get("usuario_id") %}
    {% include "componentes/edit_profile_modal.html" %}
  {% endif %}
  
  <!-- Chat flotante: include + scripts -->
  {% if session.get("usuario_id") %}
    {% include "componentes/chat.html" %}

    <!-- Socket.IO desde CDN (m√°s confiable que /socket.io/socket.io.js) -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/chat/chat-core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat/chat-panel.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat/chat-float.js') }}"></script>

  {% endif %}
</body>
</html>
