<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta name="csrf-token" content="{{ csrf_token() }}"/>
  <title>Restablecer Contrase√±a - Weigence Inventory</title>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#0f3567",
            "background-light": "#f6f7f8",
            "background-dark": "#111821",
          },
          fontFamily: {
            display: ["Inter"],
          },
          borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
        },
      },
    };
  </script>
  <style>
    body { font-family: "Inter", sans-serif; }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-300">
  <div class="flex min-h-screen flex-col items-center justify-center bg-background-light dark:bg-background-dark p-4">
    <div class="w-full max-w-md">
      <header class="mb-8 text-center">
        <div class="mb-4 inline-flex items-center gap-3">
          <svg class="h-8 w-8 text-primary" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <path d="M44 11.2727C44 14.0109 39.8386 16.3957 33.69 17.6364C39.8386 18.877 44 21.2618 44 24C44 26.7382 39.8386 29.123 33.69 30.3636C39.8386 31.6043 44 33.9891 44 36.7273C44 40.7439 35.0457 44 24 44C12.9543 44 4 40.7439 4 36.7273C4 33.9891 8.16144 31.6043 14.31 30.3636C8.16144 29.123 4 26.7382 4 24C4 21.2618 8.16144 18.877 14.31 17.6364C8.16144 16.3957 4 14.0109 4 11.2727C4 7.25611 12.9543 4 24 4C35.0457 4 44 7.25611 44 11.2727Z" fill="currentColor"></path>
          </svg>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Weigence Inventory</h1>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center justify-center gap-2">
          <span class="material-symbols-outlined text-base"> lock_reset </span>
          Restablecer contrase√±a
        </p>
      </header>
      
      <main class="rounded-xl bg-white dark:bg-gray-900/50 shadow-lg ring-1 ring-black/5 dark:ring-white/10 p-8">
        
        <!-- Estado: Validando token -->
        <div id="validating-state" class="text-center">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
          <p class="mt-4 text-gray-600 dark:text-gray-400">Validando enlace...</p>
        </div>

        <!-- Estado: Token inv√°lido/expirado -->
        <div id="invalid-state" class="hidden">
          <div class="text-center mb-6">
            <span class="material-symbols-outlined text-6xl text-red-500">error</span>
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mt-4">Enlace Inv√°lido</h2>
            <p class="text-gray-600 dark:text-gray-400 mt-2" id="error-message">
              Este enlace ha expirado o ya fue utilizado.
            </p>
          </div>
          <a href="{{ url_for('main.login') }}" class="block w-full text-center rounded-lg bg-primary px-4 py-3 font-semibold text-white hover:bg-primary/90 transition-all duration-200">
            Volver al inicio
          </a>
        </div>

        <!-- Estado: Formulario para nueva contrase√±a -->
        <div id="form-state" class="hidden">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Nueva Contrase√±a</h2>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Ingresa tu nueva contrase√±a segura.</p>
          
          <form id="reset-form">
            <input type="hidden" id="token" name="token" value=""/>
            <input type="hidden" id="email" name="email" value=""/>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="space-y-4">
              <div>
                <label for="new-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Nueva Contrase√±a
                </label>
                <div class="relative">
                  <input
                    type="password"
                    id="new-password"
                    name="new_password"
                    required
                    minlength="6"
                    class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 py-3 px-4 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-primary"
                    placeholder="M√≠nimo 6 caracteres"
                  />
                </div>
              </div>
              
              <div>
                <label for="confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Confirmar Contrase√±a
                </label>
                <div class="relative">
                  <input
                    type="password"
                    id="confirm-password"
                    name="confirm_password"
                    required
                    minlength="6"
                    class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 py-3 px-4 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-primary"
                    placeholder="Repite la contrase√±a"
                  />
                </div>
              </div>
            </div>
            
            <div id="feedback" class="mt-4 text-sm"></div>
            
            <button
              id="submit-btn"
              type="submit"
              class="mt-6 w-full rounded-lg bg-primary px-4 py-3 font-semibold text-white hover:bg-primary/90 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-background-dark active:scale-95"
            >
              Restablecer Contrase√±a
            </button>
          </form>
        </div>

        <!-- Estado: √âxito -->
        <div id="success-state" class="hidden">
          <div class="text-center mb-6">
            <span class="material-symbols-outlined text-6xl text-green-500">check_circle</span>
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mt-4">¬°Contrase√±a Restablecida!</h2>
            <p class="text-gray-600 dark:text-gray-400 mt-2">
              Tu contrase√±a ha sido actualizada exitosamente.
            </p>
          </div>
          <a href="{{ url_for('main.login') }}" class="block w-full text-center rounded-lg bg-primary px-4 py-3 font-semibold text-white hover:bg-primary/90 transition-all duration-200">
            Iniciar Sesi√≥n
          </a>
        </div>

      </main>
      
      <div class="relative mt-8">
        <div aria-hidden="true" class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300 dark:border-gray-700"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="bg-background-light dark:bg-background-dark px-2 text-gray-500 dark:text-gray-400">Weigence Inc.</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    (async function initResetPassword() {
      console.log('[ResetPassword] Inicializando p√°gina de restablecimiento');
      
      const validatingState = document.getElementById('validating-state');
      const invalidState = document.getElementById('invalid-state');
      const formState = document.getElementById('form-state');
      const successState = document.getElementById('success-state');
      const resetForm = document.getElementById('reset-form');
      const feedback = document.getElementById('feedback');
      const submitBtn = document.getElementById('submit-btn');
      const errorMessage = document.getElementById('error-message');
      
      // Obtener par√°metros de URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      const email = urlParams.get('email');
      
      console.log('[ResetPassword] Token:', token ? 'Presente' : 'Ausente');
      console.log('[ResetPassword] Email:', email);
      
      // Validar que existan los par√°metros
      if (!token || !email) {
        console.error('[ResetPassword] Faltan par√°metros token o email');
        validatingState.classList.add('hidden');
        invalidState.classList.remove('hidden');
        errorMessage.textContent = 'Enlace inv√°lido. Faltan par√°metros necesarios.';
        return;
      }
      
      // Guardar en campos hidden
      document.getElementById('token').value = token;
      document.getElementById('email').value = email;
      
      // Validar token con el servidor
      try {
        console.log('[ResetPassword] üîç Validando token con servidor...');
        const res = await fetch('/api/validate-reset-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, email })
        });
        
        const data = await res.json();
        console.log('[ResetPassword] Respuesta de validaci√≥n:', data);
        
        if (data.valid) {
          console.log('[ResetPassword] ‚úÖ Token v√°lido, mostrando formulario');
          validatingState.classList.add('hidden');
          formState.classList.remove('hidden');
        } else {
          console.error('[ResetPassword] ‚ùå Token inv√°lido:', data.message);
          validatingState.classList.add('hidden');
          invalidState.classList.remove('hidden');
          errorMessage.textContent = data.message || 'El enlace ha expirado o ya fue utilizado.';
        }
      } catch (err) {
        console.error('[ResetPassword] Error al validar token:', err);
        validatingState.classList.add('hidden');
        invalidState.classList.remove('hidden');
        errorMessage.textContent = 'Error de conexi√≥n. Intenta nuevamente m√°s tarde.';
      }
      
      // Manejar env√≠o del formulario
      if (resetForm) {
        resetForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          console.log('[ResetPassword] üì§ Enviando nueva contrase√±a...');
          
          const newPassword = document.getElementById('new-password').value;
          const confirmPassword = document.getElementById('confirm-password').value;
          
          // Validar que las contrase√±as coincidan
          if (newPassword !== confirmPassword) {
            feedback.textContent = '‚ùå Las contrase√±as no coinciden';
            feedback.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
            return;
          }
          
          if (newPassword.length < 6) {
            feedback.textContent = '‚ùå La contrase√±a debe tener al menos 6 caracteres';
            feedback.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
            return;
          }
          
          submitBtn.disabled = true;
          submitBtn.textContent = 'Actualizando...';
          feedback.textContent = '';
          
          try {
            const res = await fetch('/api/reset-password', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
              },
              body: JSON.stringify({
                token: token,
                email: email,
                new_password: newPassword
              })
            });
            
            const data = await res.json();
            console.log('[ResetPassword] Respuesta de actualizaci√≥n:', data);
            
            if (data.success) {
              console.log('[ResetPassword] ‚úÖ Contrase√±a actualizada correctamente');
              formState.classList.add('hidden');
              successState.classList.remove('hidden');
            } else {
              console.error('[ResetPassword] ‚ùå Error al actualizar:', data.message);
              feedback.textContent = '‚ùå ' + (data.message || 'Error al actualizar la contrase√±a');
              feedback.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
              submitBtn.disabled = false;
              submitBtn.textContent = 'Restablecer Contrase√±a';
            }
          } catch (err) {
            console.error('[ResetPassword] Error de conexi√≥n:', err);
            feedback.textContent = '‚ùå Error de conexi√≥n. Intenta nuevamente.';
            feedback.className = 'mt-4 text-sm text-red-600 dark:text-red-400';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Restablecer Contrase√±a';
          }
        });
      }
    })();
  </script>
</body>
</html>
