{% extends "base.html" %}
{% block title %}Auditoría Inteligente - Weigence{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/auditoria.css') }}?v=10.1">
{% endblock %}

{% block top %}{% include "componentes/header.html" %}{% endblock %}
{% block sidebar %}{% include "componentes/sidebar.html" %}{% endblock %}

{% block contenido %}

<div class="w-full space-y-8 font-sans text-neutral-800 dark:text-[#EAEAEA]">

  <!-- TARJETA SUPERIOR: BUSCADOR COMPACTO -->
  <section class="rounded-lg border border-gray-300 dark:border-neutral-700 bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] shadow-soft backdrop-blur">
    <div class="p-2 space-y-2">

      <!-- BUSCADOR Y BOTONES RESPONSIVOS -->
      <div class="flex flex-wrap items-center gap-2">
        <div class="relative flex-grow min-w-[200px] w-full sm:w-auto">
          <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-neutral-400 dark:text-white/40 text-sm sm:hidden">search</span>
          <input
            id="audit-search"
            type="text"
            placeholder="usuario:nombre rut:12345678-9 tipo_evento:ventas"
            class="w-full bg-neutral-50 dark:bg-neutral-800 border border-gray-300 dark:border-neutral-700 rounded-md h-10 sm:h-8 pl-8 sm:pl-3 pr-3 text-sm sm:text-xs text-neutral-900 dark:text-white placeholder-neutral-400 dark:placeholder-white/40 focus:border-primary/50 focus:outline-none transition-colors"
          />
        </div>
        
        <button id="audit-exec-query" class="flex items-center justify-center gap-1 rounded-md bg-primary px-4 sm:px-3 py-2 sm:py-1.5 text-sm sm:text-xs text-white shadow hover:bg-primary/90 transition-colors w-full sm:w-auto">
          <span class="material-symbols-outlined text-base sm:text-sm">play_arrow</span>
          <span class="font-medium">Buscar</span>
        </button>
        
        <div class="flex gap-2 w-full sm:w-auto">
          <button id="audit-filter-user" class="inline-flex items-center justify-center gap-1 px-3 sm:px-2.5 py-2 sm:py-1.5 rounded-md border border-blue-300 dark:border-blue-500/30 bg-blue-50 dark:bg-blue-500/10 text-blue-700 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-500/20 transition-colors text-sm sm:text-xs flex-1 sm:flex-initial">
            <span class="material-symbols-outlined text-base sm:text-sm">person</span> 
            <span id="current-user-display" class="hidden sm:inline">Mi usuario</span>
            <span class="sm:hidden">Usuario</span>
          </button>
          
          <button id="audit-active-users" class="inline-flex items-center justify-center gap-1 px-3 sm:px-2.5 py-2 sm:py-1.5 rounded-md border border-green-300 dark:border-green-500/30 bg-green-50 dark:bg-green-500/10 text-green-700 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-500/20 transition-colors text-sm sm:text-xs flex-1 sm:flex-initial">
            <span class="material-symbols-outlined text-base sm:text-sm">group</span> 
            <span id="active-user-count" class="font-semibold">0</span>
            <span class="hidden sm:inline">Activos</span>
          </button>
        </div>
        
        <div class="flex gap-2 w-full sm:w-auto">
          <button id="audit-export-csv" class="inline-flex items-center justify-center gap-1 px-3 sm:px-2.5 py-2 sm:py-1.5 rounded-md border border-gray-300 dark:border-neutral-700 bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-white hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors text-sm sm:text-xs flex-1 sm:flex-initial" title="Exportar CSV">
            <span class="material-symbols-outlined text-base sm:text-sm">file_download</span>
            <span class="sm:hidden">CSV</span>
          </button>
          
          <button id="audit-export-pdf" class="inline-flex items-center justify-center gap-1 px-3 sm:px-2.5 py-2 sm:py-1.5 rounded-md border border-gray-300 dark:border-neutral-700 bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-white hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors text-sm sm:text-xs flex-1 sm:flex-initial" title="Exportar PDF">
            <span class="material-symbols-outlined text-base sm:text-sm">picture_as_pdf</span>
            <span class="sm:hidden">PDF</span>
          </button>
          
          <button id="audit-export-zip" class="inline-flex items-center justify-center gap-1 px-3 sm:px-2.5 py-2 sm:py-1.5 rounded-md border border-gray-300 dark:border-neutral-700 bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-white hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors text-sm sm:text-xs flex-1 sm:flex-initial" title="Exportar ZIP">
            <span class="material-symbols-outlined text-base sm:text-sm">archive</span>
            <span class="sm:hidden">ZIP</span>
          </button>
        </div>
        
        <button id="audit-clear-filters" class="text-neutral-500 dark:text-white/40 hover:text-neutral-900 dark:hover:text-white text-xs sm:text-xs uppercase tracking-wide w-full sm:w-auto sm:ml-auto py-2 sm:py-0 border sm:border-0 border-neutral-300 dark:border-neutral-700 rounded-md sm:rounded-none">
          Limpiar filtros
        </button>
      </div>

      <!-- FILTROS ACTIVOS -->
      <div id="audit-active-filters" class="flex flex-wrap gap-1 min-h-0"></div>

    </div>
  </section>

  <!-- GRID PRINCIPAL RESPONSIVO: TERMINAL IZQUIERDA | IA DERECHA -->
  <section class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6 mt-6 sm:mt-8">

    <!-- TERMINAL + LIVE AUDIT TRAIL -->
    <div class="col-span-1 lg:col-span-8 space-y-4 sm:space-y-6">

      <!-- LIVE AUDIT TRAIL -->
      <div class="rounded-lg sm:rounded-xl border border-gray-300 dark:border-neutral-700 bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] shadow-xl h-[400px] sm:h-[480px] lg:h-[580px] xl:h-[620px] flex flex-col">

        <!-- HEADER RESPONSIVO -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between border-b border-gray-300 dark:border-neutral-700 px-3 sm:px-5 py-3 bg-gradient-to-r from-neutral-50 dark:from-white/5 to-transparent gap-3 sm:gap-0">
          <div class="w-full sm:w-auto">
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-primary text-lg sm:text-xl">terminal</span>
              <p class="uppercase tracking-wider text-neutral-600 dark:text-white/70 text-xs font-semibold">
                Live Audit Trail
              </p>
            </div>
            <p class="text-xs text-neutral-500 dark:text-white/50 mt-0.5">
              Monitoreo en tiempo real · Sistema de eventos
            </p>
          </div>

          <div class="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-end">
            <!-- Stats rápidas -->
            <div id="audit-quick-stats" class="hidden sm:flex md:flex items-center gap-2 lg:gap-4 text-xs mr-0 lg:mr-4">
              <div class="flex items-center gap-1.5">
                <span class="text-green-400">●</span>
                <span class="text-neutral-600 dark:text-white/60 hidden lg:inline">INFO:</span>
                <span id="stat-info" class="text-neutral-900 dark:text-white font-semibold">0</span>
              </div>
              <div class="flex items-center gap-1.5">
                <span class="text-yellow-400">●</span>
                <span class="text-neutral-600 dark:text-white/60 hidden lg:inline">WARN:</span>
                <span id="stat-warn" class="text-neutral-900 dark:text-white font-semibold">0</span>
              </div>
              <div class="flex items-center gap-1.5">
                <span class="text-red-400">●</span>
                <span class="text-neutral-600 dark:text-white/60 hidden lg:inline">CRIT:</span>
                <span id="stat-crit" class="text-neutral-900 dark:text-white font-semibold">0</span>
              </div>
            </div>
            
            <div class="flex items-center gap-2 bg-neutral-100 dark:bg-neutral-800 rounded-full px-2 sm:px-3 py-1.5">
              <div id="audit-stream-status" class="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-lg shadow-green-500/50"></div>
              <span id="audit-last-updated" class="text-xs text-neutral-600 dark:text-white/60 font-medium">
                <span class="hidden sm:inline">Sincronizando...</span>
                <span class="sm:hidden">Sync...</span>
              </span>
            </div>
          </div>
        </div>

        <!-- TERMINAL - CONSOLA DE LOGS RESPONSIVA -->
        <div class="px-3 sm:px-4 pt-2 sm:pt-3 pb-2 sm:pb-3 bg-gradient-to-b from-neutral-100 to-neutral-50 dark:from-[#0f1014] dark:to-[#1a1b23] flex-1 overflow-hidden flex flex-col">
          <div id="audit-log-stream" class="flex-1 overflow-y-auto rounded-md sm:rounded-lg border
            bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)]
            border-gray-300 dark:border-neutral-700
            scrollbar-thin scrollbar-thumb-slate-400 dark:scrollbar-thumb-primary/40
          ">

            <div id="audit-log-empty" class="
              flex flex-col items-center justify-center h-full
              text-neutral-400 dark:text-white/30
            ">
              <span class="material-symbols-outlined text-4xl sm:text-5xl opacity-50 mb-2">hourglass_empty</span>
              <p class="text-xs sm:text-sm text-center px-4">Esperando eventos del sistema...</p>
            </div>
          </div>
        </div>

        <!-- FOOTER RESPONSIVO - MÉTRICAS DEL SISTEMA -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between border-t border-gray-300 dark:border-neutral-700 px-3 sm:px-5 py-2.5 text-xs
                    bg-gradient-to-r from-transparent to-neutral-50 dark:to-white/5 text-neutral-600 dark:text-white/50 gap-2 sm:gap-0">
          <div class="flex gap-3 sm:gap-6 font-mono flex-wrap">
            <div class="flex items-center gap-1.5">
              <span class="material-symbols-outlined text-sm">memory</span>
              <span class="hidden sm:inline">MEM:</span>
              <span id="audit-mem-usage" class="text-blue-600 dark:text-blue-400 font-semibold">--</span>
            </div>
            <div class="flex items-center gap-1.5">
              <span class="material-symbols-outlined text-sm">speed</span>
              <span class="hidden sm:inline">CPU:</span>
              <span id="audit-cpu-usage" class="text-green-600 dark:text-green-400 font-semibold">--</span>
            </div>
            <div class="flex items-center gap-1.5">
              <span class="material-symbols-outlined text-sm">network_ping</span>
              <span class="hidden sm:inline">LATENCY:</span>
              <span id="audit-latency" class="text-yellow-600 dark:text-yellow-400 font-semibold">--</span>
            </div>
          </div>

          <button id="audit-export-csv-footer" 
                  class="flex items-center gap-1.5 hover:text-neutral-900 dark:hover:text-white hover:bg-neutral-200 dark:hover:bg-neutral-700 px-3 py-1.5 rounded-md transition-all w-full sm:w-auto justify-center sm:justify-start">
            <span class="material-symbols-outlined text-sm">download</span>
            <span>Exportar logs</span>
          </button>
        </div>

      </div>

    </div>

    <!-- BLOQUE IA RESPONSIVO -->
    <div class="col-span-1 lg:col-span-4 flex">
      <article
        id="ai-recomendacion-auditoria"
        class="ia-recommendation w-full"
        data-ia-card
        data-severity="info"
        data-ia-status="idle"
        aria-live="polite"
        aria-busy="false"
      >
        <div aria-hidden="true"></div>

        <div class="ia-recommendation__body">
          
          <div class="ia-recommendation__content">
            <!-- Header Premium con Badge -->
            <div class="ia-recommendation__meta">
              <span class="material-symbols-outlined text-lg sm:text-xl" data-ia-icon style="animation: pulse 2s ease-in-out infinite;">sensors</span>
              <span data-ia-severity class="text-xs sm:text-sm font-bold tracking-wider uppercase">IA Advisor</span>
              <span class="ml-badge text-xs px-2 py-0.5 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 text-white font-bold" data-ml-badge style="display: none;">Pro</span>
            </div>

            <!-- Sección de Estado del Sistema -->
            <div class="flex items-center gap-2 mt-3 mb-4">
              <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
              <span class="text-xs font-semibold opacity-80">Sistema de Recomendaciones Activo</span>
            </div>

            <!-- Título -->
            <h4 class="ia-recommendation__title text-lg sm:text-xl font-bold leading-tight mb-3" data-ia-title>
              <span class="bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                Asistente Inteligente
              </span><br>
              <span class="text-white dark:text-white">Vigilando Tu Ecosistema</span>
            </h4>

            <!-- Módulo afectado -->
            <div class="ia-recommendation__module flex items-center gap-2 px-2.5 py-1.5 rounded-lg bg-white/5 border border-white/10 mb-2" data-ia-module style="display: none;">
              <span class="material-symbols-outlined text-sm" data-module-icon>hub</span>
              <span class="text-xs font-semibold">Módulo:</span>
              <span data-module-name class="text-xs font-bold text-blue-400">Dashboard</span>
            </div>

            <!-- Descripción -->
            <div class="ia-recommendation__message text-sm leading-relaxed mb-3" data-ia-message>
              <p class="mb-2">
                <span class="inline-block px-2 py-0.5 bg-blue-500/20 rounded text-blue-300 text-xs font-bold mb-1">¿Qué hago?</span><br>
                Analizo continuamente tu sistema buscando patrones sospechosos y oportunidades de mejora.
              </p>
              
              <p>
                <span class="inline-block px-2 py-0.5 bg-purple-500/20 rounded text-purple-300 text-xs font-bold mb-1">¿Cómo ayudo?</span><br>
                Te daré <strong>recomendaciones precisas</strong> antes de que se convierta en problema.
              </p>
            </div>

            <!-- Severidad -->
            <div class="ia-recommendation__severity-detail" data-severity-detail style="display: none;">
              <div class="flex items-center justify-between mb-1.5">
                <span class="ia-recommendation__label text-xs font-bold flex items-center gap-1">
                  <span class="material-symbols-outlined text-sm">priority_high</span>
                  Prioridad
                </span>
                <span class="severity-text text-xs font-bold px-2 py-0.5 rounded-full" data-severity-text>Baja</span>
              </div>
              <div class="severity-indicator w-full h-1.5 bg-white/10 rounded-full overflow-hidden" data-severity-indicator>
                <span class="severity-bar block h-full bg-gradient-to-r from-green-400 to-blue-500 transition-all duration-500" data-severity-bar style="width: 30%"></span>
              </div>
            </div>

            <!-- Plan de Acción -->
            <div class="ia-recommendation__solution mt-auto pt-3 border-t border-white/10">
              <div class="flex items-center gap-2 mb-2">
                <span class="material-symbols-outlined text-yellow-400 text-base">rocket_launch</span>
                <span class="ia-recommendation__label text-xs font-bold text-yellow-400 uppercase tracking-wide">Plan de Acción</span>
              </div>
              <p class="ia-recommendation__solution-text text-sm leading-relaxed" data-ia-solution>
                <strong class="text-white">Esperando datos...</strong> Pronto generaré recomendaciones inteligentes.
              </p>
            </div>
          </div>

          <!-- Navegación Mejorada -->
          <div class="ia-recommendation__navigation border-t border-white/10" data-ml-navigation style="display: none;">
            <button class="ia-nav-button ia-nav-button--prev hover:scale-110 transition-transform" data-nav-prev aria-label="Anterior" title="Insight anterior">
              <span class="material-symbols-outlined">navigate_before</span>
            </button>
            <div class="nav-counter flex items-center gap-1">
              <span class="material-symbols-outlined text-xs">analytics</span>
              <span class="text-xs font-bold" data-nav-counter>
                Insight <span data-nav-current class="text-blue-400">1</span>/<span data-nav-total>6</span>
              </span>
            </div>
            <button class="ia-nav-button ia-nav-button--next hover:scale-110 transition-transform" data-nav-next aria-label="Siguiente" title="Siguiente insight">
              <span class="material-symbols-outlined">navigate_next</span>
            </button>
          </div>

        </div>
      </article>
    </div>

  </section>
</div>



<!-- Terminal output (oculto, usado internamente) -->
<div id="audit-terminal-output" class="hidden"></div>

<style>
@keyframes pulse-glow {
  0%, 100% { opacity: 1; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); }
  50% { opacity: 0.6; box-shadow: 0 0 12px rgba(34, 197, 94, 0.8); }
}

.user-highlight {
  background: linear-gradient(120deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.dark .user-highlight {
  background: linear-gradient(120deg, rgba(59, 130, 246, 0.15) 0%, rgba(147, 51, 234, 0.15) 100%);
  border-color: rgba(59, 130, 246, 0.3);
}
</style>

<script>
// ============================================
// HEARTBEAT - MANTENER SESIÓN ACTIVA
// ============================================
(function() {
  const HEARTBEAT_INTERVAL = 15000; // 15 segundos
  let heartbeatCount = 0;
  
  async function enviarHeartbeat() {
    try {
      heartbeatCount++;
      const timestamp = new Date().toISOString();
      console.log(`💓 [${heartbeatCount}] Enviando heartbeat a las ${new Date().toLocaleTimeString()}`);
      
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      const response = await fetch('/api/usuarios/heartbeat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          pagina: 'auditoria',
          timestamp: timestamp
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log(`✅ [${heartbeatCount}] Heartbeat OK - Total conectados: ${data.total_conectados || '?'}`);
      } else {
        console.error(`❌ [${heartbeatCount}] Heartbeat falló: ${response.status} ${response.statusText}`);
      }
    } catch (error) {
      console.error(`❌ [${heartbeatCount}] Error enviando heartbeat:`, error);
    }
  }
  
  // Enviar heartbeat inicial
  enviarHeartbeat();
  
  // Enviar heartbeat cada 15 segundos
  setInterval(enviarHeartbeat, HEARTBEAT_INTERVAL);
  
  console.log('✅ Sistema de heartbeat inicializado en auditoría (cada 15 segundos)');
})();
</script>
{% endblock %}
