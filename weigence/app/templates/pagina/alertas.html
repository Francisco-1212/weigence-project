{% extends "base.html" %}

{% block content %}
{% block title %}Alertas - Weigence{% endblock %}

{% block sidebar %}
{% include "componentes/sidebar.html" %}
{% endblock %}

{% block top %}
{% include "componentes/header.html" %}
{% endblock %}

{% block contenido %}
<div class="p-8">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold">Alertas del Sistema</h1>
      <p class="text-slate-500 dark:text-slate-400 text-sm">Administra y monitorea todas las alertas del sistema en tiempo real.</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-exportar-alertas"
        class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white dark:bg-neutral-800 border-2 border-gray-300 dark:border-neutral-700 text-neutral-700 dark:text-neutral-300 shadow-sm hover:shadow-md hover:border-green-500 dark:hover:border-green-500 hover:text-green-600 dark:hover:text-green-400 transition-all duration-200">
        <span class="material-symbols-outlined text-base">download</span>
        <span>Exportar</span>
      </button>
    </div>
  </div>

  <!-- Tarjetas de resumen -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="flex flex-col gap-2 rounded-xl p-6 bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] border border-gray-300 dark:border-neutral-700 shadow-sm">
      <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Total Alertas</p>
      <p id="total-alertas" class="text-3xl font-bold">{{ total_alertas }}</p>
    </div>
    <div class="flex flex-col gap-2 rounded-xl p-6 bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] border border-gray-300 dark:border-neutral-700 shadow-sm">
      <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Alertas Pendientes</p>
      <p id="alertas-pendientes" class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">{{ alertas_pendientes }}</p>
    </div>
    <div class="flex flex-col gap-2 rounded-xl p-6 bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] border border-gray-300 dark:border-neutral-700 shadow-sm">
      <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Alertas Resueltas</p>
      <p id="alertas-resueltas" class="text-3xl font-bold text-green-600 dark:text-green-400">{{ alertas_resueltas }}</p>
    </div>
  </div>

  <!-- Panel de Filtros -->
  <div class="bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] rounded-xl border border-gray-300 dark:border-neutral-700 shadow-sm p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="p-2 rounded-lg bg-blue-100 dark:bg-blue-900/30">
          <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">filter_alt</span>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-neutral-900 dark:text-neutral-100">Filtros de B√∫squeda</h3>
          <p class="text-sm text-neutral-600 dark:text-neutral-400">Filtra las alertas seg√∫n tus criterios</p>
        </div>
      </div>
      <button id="btn-limpiar-filtros" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 dark:border-neutral-700 text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors">
        <span class="material-symbols-outlined text-sm">restart_alt</span>
        <span class="text-sm font-medium">Limpiar filtros</span>
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Filtro por Estado -->
      <div>
        <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
          <span class="flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">toggle_on</span>
            Estado
          </span>
        </label>
        <select id="filtro-estado" class="w-full px-3 py-2 rounded-lg bg-white dark:bg-neutral-800 border border-gray-300 dark:border-neutral-700 text-neutral-900 dark:text-neutral-100 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors">
          <option value="">Todos los estados</option>
          <option value="pendiente">Pendiente</option>
          <option value="resuelto">Resuelto</option>
        </select>
      </div>

      <!-- Filtro por Tipo -->
      <div>
        <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
          <span class="flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">label</span>
            Tipo de Alerta
          </span>
        </label>
        <select id="filtro-tipo" class="w-full px-3 py-2 rounded-lg bg-white dark:bg-neutral-800 border border-gray-300 dark:border-neutral-700 text-neutral-900 dark:text-neutral-100 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors">
          <option value="">Todos los tipos</option>
          <option value="rojo">üî¥ Rojo (Stock agotado)</option>
          <option value="amarillo">üü° Amarillo (Bajo stock)</option>
        </select>
      </div>

      <!-- Filtro por Fecha -->
      <div>
        <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
          <span class="flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">calendar_today</span>
            Fecha desde
          </span>
        </label>
        <input type="date" id="filtro-fecha-desde" class="w-full px-3 py-2 rounded-lg bg-white dark:bg-neutral-800 border border-gray-300 dark:border-neutral-700 text-neutral-900 dark:text-neutral-100 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors">
      </div>

      <div>
        <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
          <span class="flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">calendar_today</span>
            Fecha hasta
          </span>
        </label>
        <input type="date" id="filtro-fecha-hasta" class="w-full px-3 py-2 rounded-lg bg-white dark:bg-neutral-800 border border-gray-300 dark:border-neutral-700 text-neutral-900 dark:text-neutral-100 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors">
      </div>
    </div>

    <!-- Resumen de Filtros Activos -->
    <div id="filtros-activos" class="mt-4 hidden">
      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Filtros activos:</span>
        <div id="filtros-activos-chips" class="flex items-center gap-2 flex-wrap"></div>
      </div>
    </div>
  </div>

  <!-- Tabla de alertas -->
  <div class="bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] border border-gray-300 dark:border-neutral-700 rounded-xl shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-300 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/50">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-lg bg-red-100 dark:bg-red-900/30">
            <span class="material-symbols-outlined text-red-600 dark:text-red-400">notification_important</span>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-neutral-900 dark:text-neutral-100">Historial de Alertas</h3>
            <p class="text-sm text-neutral-600 dark:text-neutral-400">Gestiona las alertas del sistema</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="alertas-counter" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
            <span class="w-2 h-2 rounded-full bg-blue-600 dark:bg-blue-400 mr-2 animate-pulse"></span>
            {{ alertas|length }} alertas
          </span>
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="alertasTable" class="w-full text-sm">
        <thead class="bg-neutral-100 dark:bg-neutral-800 border-b-2 border-gray-300 dark:border-neutral-700">
          <tr>
            <th class="px-4 py-4 text-left text-xs font-semibold text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Alerta</th>
            <th class="px-4 py-4 text-left text-xs font-semibold text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Usuario</th>
            <th class="px-4 py-4 text-left text-xs font-semibold text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Fecha</th>
            <th class="px-4 py-4 text-center text-xs font-semibold text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Tipo</th>
            <th class="px-4 py-4 text-center text-xs font-semibold text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Estado</th>
            <th class="px-4 py-4 text-center text-xs font-semibold text-neutral-700 dark:text-neutral-300 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-neutral-700 bg-white dark:bg-neutral-900">
          {% for alerta in alertas %}
          <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition-all duration-200 alerta-row"
              data-id="{{ alerta.id }}"
              data-titulo="{{ alerta.titulo }}"
              data-descripcion="{{ alerta.descripcion }}"
              data-tipo="{{ alerta.tipo_color }}"
              data-estado="{{ alerta.estado }}"
              data-fecha="{{ alerta.fecha_creacion }}"
              data-producto="{{ alerta.nombre_producto }}"
              data-usuario="{{ alerta.nombre_usuario }}">
            <td class="px-4 py-4">
              <div class="text-sm font-semibold text-slate-900 dark:text-slate-100">{{ alerta.titulo }}</div>
              <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">{{ alerta.descripcion }}</div>
              <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                <span class="inline-flex items-center gap-1">
                  <span class="material-symbols-outlined text-xs">inventory_2</span>
                  {{ alerta.nombre_producto }}
                </span>
              </div>
            </td>
            <td class="px-4 py-4 whitespace-nowrap">
              <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-slate-500 dark:text-slate-400">person</span>
                <span class="text-slate-700 dark:text-slate-300">{{ alerta.nombre_usuario }}</span>
              </div>
            </td>
            <td class="px-4 py-4 whitespace-nowrap text-slate-700 dark:text-slate-300">{{ alerta.fecha_formateada }}</td>
            <td class="px-4 py-4 text-center">
              <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold
                {% if alerta.tipo_color == 'rojo' %}
                  bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300
                {% elif alerta.tipo_color == 'amarillo' or alerta.tipo_color == 'amarilla' %}
                  bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300
                {% else %}
                  bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-300
                {% endif %}">
                {% if alerta.tipo_color == 'rojo' %}
                  <span class="text-base">üî¥</span> CR√çTICO
                {% elif alerta.tipo_color == 'amarillo' or alerta.tipo_color == 'amarilla' %}
                  <span class="text-base">üü°</span> ADVERTENCIA
                {% else %}
                  {{ alerta.tipo_color|default('info')|title }}
                {% endif %}
              </span>
            </td>
            <td class="px-4 py-4 text-center">
              <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium
                {% if alerta.estado == 'pendiente' %}
                  bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300
                {% elif alerta.estado == 'resuelto' %}
                  bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300
                {% else %}
                  bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-300
                {% endif %}">
                <span class="material-symbols-outlined text-sm">
                  {% if alerta.estado == 'pendiente' %}schedule{% elif alerta.estado == 'resuelto' %}check_circle{% else %}help{% endif %}
                </span>
                {{ alerta.estado|default('pendiente')|title }}
              </span>
            </td>
            <td class="px-4 py-4 text-center">
              <button class="btn-gestionar-alerta inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-primary-500 hover:bg-primary-600 text-white text-xs font-semibold transition-colors" data-alerta-id="{{ alerta.id }}">
                <span class="material-symbols-outlined text-sm">settings</span>
                Gestionar
              </button>
            </td>
          </tr>
          {% else %}
          <tr id="noAlertasRow">
            <td colspan="6" class="px-4 py-12 text-center">
              <div class="flex flex-col items-center gap-3">
                <span class="material-symbols-outlined text-5xl text-slate-400">notifications_off</span>
                <p class="text-slate-500 dark:text-slate-400 font-medium">No hay alertas registradas</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Controles de paginaci√≥n -->
  <div id="alertasPager"
      class="flex flex-wrap items-center justify-between gap-4 py-4 px-6 bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] border border-gray-300 dark:border-neutral-700 rounded-xl mt-4 shadow-sm">
    <div class="flex items-center gap-3">
      <span class="material-symbols-outlined text-neutral-600 dark:text-neutral-400">table_rows</span>
      <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Filas por p√°gina:</span>
      <select id="alertasPageSize" class="h-10 px-3 rounded-lg bg-white dark:bg-neutral-800 border border-gray-300 dark:border-neutral-700 text-neutral-900 dark:text-neutral-100 font-medium shadow-sm hover:border-primary-500 focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors">
        <option>10</option><option>25</option><option>50</option><option>100</option>
      </select>
    </div>
    <div class="flex items-center gap-2 text-sm font-medium text-neutral-700 dark:text-neutral-300 bg-neutral-100 dark:bg-neutral-800 px-4 py-2 rounded-lg">
      <span class="material-symbols-outlined text-base">description</span>
      <span id="alertasPageStats">0‚Äì0 de 0</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="alertasPrevPage" class="h-10 px-4 border border-gray-300 dark:border-neutral-700 rounded-lg text-neutral-700 dark:text-neutral-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:border-primary-500 dark:hover:border-primary-500 hover:text-primary-600 dark:hover:text-primary-400 transition-all duration-200 font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Anterior">
        <span class="flex items-center gap-1">
          <span class="material-symbols-outlined text-base">chevron_left</span>
          <span class="hidden sm:inline">Anterior</span>
        </span>
      </button>
      <button id="alertasNextPage" class="h-10 px-4 border border-gray-300 dark:border-neutral-700 rounded-lg text-neutral-700 dark:text-neutral-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:border-primary-500 dark:hover:border-primary-500 hover:text-primary-600 dark:hover:text-primary-400 transition-all duration-200 font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Siguiente">
        <span class="flex items-center gap-1">
          <span class="hidden sm:inline">Siguiente</span>
          <span class="material-symbols-outlined text-base">chevron_right</span>
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Modal de Gesti√≥n de Alerta -->
<div id="modal-gestionar-alerta" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
  <div class="relative w-full max-w-2xl bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] border border-gray-300 dark:border-neutral-700 rounded-2xl shadow-2xl" onclick="event.stopPropagation()">
    <div class="p-6">
      <!-- Header del Modal -->
      <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-300 dark:border-neutral-700">
        <div class="flex items-center gap-3">
          <div class="p-3 rounded-xl bg-gradient-to-br from-red-500 to-orange-600">
            <span class="material-symbols-outlined text-white text-2xl">notification_important</span>
          </div>
          <div>
            <h2 class="text-xl font-bold text-neutral-900 dark:text-neutral-100">Gestionar Alerta</h2>
            <p class="text-sm text-neutral-600 dark:text-neutral-400">Edita el estado de la alerta</p>
          </div>
        </div>
        <button class="close-modal-alerta p-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors">
          <span class="material-symbols-outlined text-neutral-600 dark:text-neutral-400">close</span>
        </button>
      </div>

      <!-- Contenido del Modal -->
      <div class="space-y-4">
        <div class="bg-neutral-50 dark:bg-neutral-800/50 rounded-lg p-4 border border-gray-300 dark:border-neutral-700">
          <h3 id="modal-titulo" class="text-lg font-bold text-neutral-900 dark:text-neutral-100 mb-2"></h3>
          <p id="modal-descripcion" class="text-sm text-neutral-600 dark:text-neutral-400 mb-3"></p>
          <div class="grid grid-cols-2 gap-3 text-xs">
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-slate-500">inventory_2</span>
              <span class="text-neutral-700 dark:text-neutral-300">Producto: <strong id="modal-producto"></strong></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-slate-500">person</span>
              <span class="text-neutral-700 dark:text-neutral-300">Usuario: <strong id="modal-usuario"></strong></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-slate-500">calendar_today</span>
              <span class="text-neutral-700 dark:text-neutral-300">Fecha: <strong id="modal-fecha"></strong></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-slate-500">label</span>
              <span class="text-neutral-700 dark:text-neutral-300">Tipo: <strong id="modal-tipo"></strong></span>
            </div>
          </div>
        </div>

        <!-- Cambiar Estado -->
        <div>
          <label class="block text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-2">
            <span class="flex items-center gap-2">
              <span class="material-symbols-outlined text-sm">toggle_on</span>
              Cambiar Estado
            </span>
          </label>
          <select id="modal-estado" class="w-full px-4 py-3 rounded-lg bg-white dark:bg-neutral-800 border-2 border-gray-300 dark:border-neutral-700 text-neutral-900 dark:text-neutral-100 font-medium focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-colors">
            <option value="pendiente">‚è≥ Pendiente</option>
            <option value="resuelto">‚úÖ Resuelto</option>
          </select>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="flex gap-3 pt-4 border-t border-gray-300 dark:border-neutral-700">
          <button type="button" class="close-modal-alerta flex-1 px-4 py-3 rounded-lg border-2 border-gray-300 dark:border-neutral-700 text-neutral-700 dark:text-neutral-300 font-semibold hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors">
            Cancelar
          </button>
          <button type="button" onclick="Alertas.guardarCambios()" class="flex-1 px-4 py-3 rounded-lg bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold hover:from-primary-600 hover:to-primary-700 transition-all shadow-md hover:shadow-lg">
            <span class="flex items-center justify-center gap-2">
              <span class="material-symbols-outlined">save</span>
              Guardar Cambios
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  console.log('üîµ [HTML] Script block ejecutado - INLINE');
  console.log('üîµ [HTML] Total de alertas en p√°gina:', {{ alertas|length }});
  
  // Test de carga
  console.log('üîµ [HTML] URL del JS:', "{{ url_for('static', filename='js/alertas.js') }}");
  
  // Verificar que los elementos existen al cargar
  window.addEventListener('DOMContentLoaded', () => {
    console.log('üîµ [HTML] DOM verificaci√≥n:');
    console.log('  - #alertasTable:', !!document.getElementById('alertasTable'));
    console.log('  - #modal-gestionar-alerta:', !!document.getElementById('modal-gestionar-alerta'));
    console.log('  - #alertasPageSize:', !!document.getElementById('alertasPageSize'));
    console.log('  - #alertasPrevPage:', !!document.getElementById('alertasPrevPage'));
    console.log('  - #alertasNextPage:', !!document.getElementById('alertasNextPage'));
    console.log('  - .alerta-row:', document.querySelectorAll('.alerta-row').length);
    console.log('  - .btn-gestionar-alerta:', document.querySelectorAll('.btn-gestionar-alerta').length);
  });
</script>
<script src="{{ url_for('static', filename='js/alertas.js') }}?v={{ range(1, 10000)|random }}"></script>
<script>
  // Verificar si el archivo se carg√≥
  setTimeout(() => {
    if (typeof Alertas === 'undefined') {
      console.error('‚ùå‚ùå‚ùå CR√çTICO: alertas.js NO SE CARG√ì');
      console.error('La variable Alertas no existe en el scope global');
      console.error('Esto significa que el archivo JS no se ejecut√≥');
    } else {
      console.log('‚úÖ‚úÖ‚úÖ alertas.js CARGADO CORRECTAMENTE');
      console.log('Objeto Alertas:', Alertas);
    }
  }, 500);
</script>
{% endblock %}
{% endblock %}