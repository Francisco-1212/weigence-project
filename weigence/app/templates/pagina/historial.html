<div id="historial-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm" role="dialog" aria-modal="true">
  <div class="relative bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] border border-neutral-300 dark:border-[var(--border-dark)] rounded-xl shadow-xl max-w-6xl w-[94%] max-h-[90vh] overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b border-neutral-300 dark:border-[var(--border-dark)]">
      <h2 class="text-xl font-bold text-[var(--text-light)] dark:text-[var(--text-dark)]">Historial del Sistema</h2>
      <button type="button" data-close class="text-neutral-500 hover:text-red-500 focus:outline-none">
        <span class="material-symbols-outlined text-lg">close</span>
      </button>
    </div>

    <div class="px-6 py-3 flex gap-2 border-b border-neutral-300 dark:border-[var(--border-dark)]">
      <button type="button" class="tab-btn px-3 py-1.5 text-sm font-medium rounded-md transition-all focus:outline-none focus:ring-2 focus:ring-primary-500" data-tab="mov">Movimientos</button>
      <button type="button" class="tab-btn px-3 py-1.5 text-sm font-medium rounded-md transition-all focus:outline-none focus:ring-2 focus:ring-primary-500" data-tab="err">Errores</button>
    </div>

    <div class="p-6 overflow-y-auto max-h-[70vh] space-y-6">
      <!-- Movimientos -->
      <div id="panel-mov" class="tab-content">
        <table class="w-full text-sm border border-neutral-300 dark:border-[var(--border-dark)] rounded-lg overflow-hidden">
          <thead class="bg-neutral-200 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-200">
            <tr>
              <th class="p-2 text-left">Producto</th>
              <th class="p-2 text-left">Tipo</th>
              <th class="p-2 text-right">Cantidad</th>
              <th class="p-2 text-left">Tipo</th>
              <th class="p-2 text-left">Usuario</th>
              <th class="p-2 text-right">Fecha</th>
            </tr>
          </thead>
          <tbody class="bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] divide-y divide-neutral-300 dark:divide-[var(--border-dark)]">
            {% for m in movimientos %}
            <tr>
              <td class="p-2">{{ m.producto }}</td>
              <td class="p-2">
                {% if m.tipo_evento == 'Añadir' %}<span class="text-green-600">Entrada</span>
                {% elif m.tipo_evento == 'Retirar' %}<span class="text-red-500">Retiro</span>
                {% else %}<span class="text-blue-500">Mover</span>{% endif %}
              </td>
              <td class="p-2 text-right">
                {% if m.tipo_evento == 'Añadir' %}+{% elif m.tipo_evento == 'Retirar' %}-{% endif %}{{ m.cantidad }} kg
              </td>
              <td class="p-2">{{ m.ubicacion or "—" }}</td>
              <td class="p-2">{{ m.usuario_nombre or "Desconocido" }}</td>
              <td class="p-2 text-right">{{ m.timestamp.split('T')[0] ~ " " ~ m.timestamp.split('T')[1][:5] if 'T' in m.timestamp else m.timestamp }}</td>
            </tr>
            {% else %}
            <tr><td class="p-3 text-center text-xs text-neutral-500 dark:text-neutral-400" colspan="6">Sin movimientos</td></tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="flex justify-center mt-6">
          <a href="{{ url_for('main.movimientos') }}" class="inline-flex items-center gap-2 text-sm font-semibold text-primary-600 dark:text-primary-400 hover:underline underline-offset-2">
            <span class="material-symbols-outlined text-sm">open_in_new</span>
            Ir a pantalla de movimientos
          </a>
        </div>
      </div>

      <!-- Errores -->
      <div id="panel-err" class="tab-content hidden">
        <table class="w-full text-sm border border-neutral-300 dark:border-[var(--border-dark)] rounded-lg overflow-hidden">
          <thead class="bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300">
            <tr>
              <th class="p-2 text-left">Tipo</th>
              <th class="p-2 text-left">Descripción</th>
              <th class="p-2 text-right">Fecha</th>
              <th class="p-2 text-center">Estado</th>
            </tr>
          </thead>
          <tbody class="bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] divide-y divide-neutral-300 dark:divide-[var(--border-dark)]">
            {% for e in errores %}
            <tr>
              <td class="p-2">{{ e.tipo }}</td>
              <td class="p-2">{{ e.descripcion or "Sin detalles" }}</td>
              <td class="p-2 text-right">{{ e.fecha_creacion }}</td>
              <td class="p-2 text-center">
                {% if e.estado == "pendiente" %}
                  <span class="text-yellow-500 font-medium">Pendiente</span>
                {% else %}
                  <span class="text-green-500 font-medium">Resuelto</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td class="p-3 text-center text-xs text-neutral-500 dark:text-neutral-400" colspan="4">Sin errores</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
