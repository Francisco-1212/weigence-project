<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta name="csrf-token" content="{{ csrf_token() }}"/>
  <title>Weigence Inventory Login</title>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#0f3567",
            "background-light": "#f6f7f8",
            "background-dark": "#111821",
          },
          fontFamily: {
            display: ["Inter"],
          },
          borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
        },
      },
    };
  </script>
  <style>
    body { font-family: "Inter", sans-serif; }
    .form-input-group { position: relative; }
    .form-input-group .material-symbols-outlined {
      position: absolute;
      top: 50%;
      left: 1rem;
      transform: translateY(-50%);
      color: #9ca3af;
      transition: color 0.2s ease-in-out;
    }
    .form-input:focus + .material-symbols-outlined {
      color: #3182ce;
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-300">
  <div class="flex min-h-screen flex-col items-center justify-center bg-background-light dark:bg-background-dark p-4">
    <div class="w-full max-w-md">
      <header class="mb-8 text-center">
        <div class="mb-4 inline-flex items-center gap-3">
          <svg class="h-8 w-8 text-primary" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <path d="M44 11.2727C44 14.0109 39.8386 16.3957 33.69 17.6364C39.8386 18.877 44 21.2618 44 24C44 26.7382 39.8386 29.123 33.69 30.3636C39.8386 31.6043 44 33.9891 44 36.7273C44 40.7439 35.0457 44 24 44C12.9543 44 4 40.7439 4 36.7273C4 33.9891 8.16144 31.6043 14.31 30.3636C8.16144 29.123 4 26.7382 4 24C4 21.2618 8.16144 18.877 14.31 17.6364C8.16144 16.3957 4 14.0109 4 11.2727C4 7.25611 12.9543 4 24 4C35.0457 4 44 7.25611 44 11.2727Z" fill="currentColor"></path>
          </svg>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Weigence Inventory</h1>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center justify-center gap-2">
          <span class="material-symbols-outlined text-base"> lock </span>
          Inicio de sesi√≥n seguro
        </p>
      </header>
      <main class="rounded-xl bg-white dark:bg-gray-900/50 shadow-lg ring-1 ring-black/5 dark:ring-white/10 p-8">
        {% with messages = get_flashed_messages(category_filter=["error", "warning", "info"]) %}
        {% if messages %}
        <div class="mb-6 rounded bg-red-100 dark:bg-red-800/40 text-red-700 dark:text-red-300 p-3 font-semibold border border-red-400" role="alert">
          {% for msg in messages %}
            <p>{{ msg }}</p>
          {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        <form action="{{ url_for('main.login') }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="space-y-6">
            <div class="form-input-group">
              <input class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 py-3 pl-12 pr-4 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-primary focus:ring-opacity-50 transition-all duration-200"
                     id="usuario" name="usuario" placeholder="Email o usuario" autocomplete="username" required type="text"/>
              <span class="material-symbols-outlined"> mail </span>
            </div>
            <div class="form-input-group relative flex items-center">
              <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-400 pointer-events-none z-10">password</span>
              <input class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 py-3 pl-12 pr-10 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-primary focus:ring-opacity-50 transition-all duration-200"
                     id="password" name="password" placeholder="Contrase√±a" autocomplete="current-password" required type="password"/>
              <button id="toggle-password" type="button" class="absolute right-2 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors focus:outline-none hidden z-20"
                      aria-label="Mostrar/ocultar contrase√±a" tabindex="-1" style="pointer-events: auto;">
                <span class="material-symbols-outlined text-lg">visibility</span>
              </button>
            </div>
          </div>
          <div class="mt-6 flex items-center justify-between">
            <div class="flex items-center">
              <input class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-primary bg-gray-100 dark:bg-gray-700 focus:ring-primary" id="remember" name="remember" type="checkbox" value="on"/>
              <label class="ml-2 block text-sm text-gray-700 dark:text-gray-300" for="remember">Recordarme</label>
            </div>
            <div class="text-sm">
              <a id="forgot-link" class="font-medium text-primary hover:text-primary/80 transition-colors duration-200 cursor-pointer" href="#">¬øOlvidaste tu contrase√±a?</a>
            </div>
          </div>
          <div class="mt-8">
            <button class="flex w-full justify-center rounded-lg bg-primary px-4 py-3 font-semibold text-white shadow-sm transition-all duration-200 hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-background-dark active:scale-95" type="submit">
              Ingresar
            </button>
          </div>
        </form>
        <div class="relative mt-8">
          <div aria-hidden="true" class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-300 dark:border-gray-700"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="bg-white dark:bg-gray-900 px-2 text-gray-500 dark:text-gray-400">Weigence Inc.</span>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal de recuperaci√≥n de contrase√±a (todo en este archivo) -->
  <div id="forgot-modal" class="fixed inset-0 z-50 hidden items-center justify-center px-4 py-6">
    <div id="forgot-overlay" class="absolute inset-0 bg-black/50"></div>
    <div role="dialog" aria-modal="true" aria-labelledby="forgot-title" class="relative z-10 w-full max-w-md rounded-xl bg-white dark:bg-gray-900 p-6 shadow-lg ring-1 ring-black/5 dark:ring-white/10">
      <h3 id="forgot-title" class="text-lg font-semibold text-gray-900 dark:text-white">Recuperar contrase√±a</h3>
      <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Introduce tu correo electr√≥nico y te enviaremos un enlace para restablecer la contrase√±a.</p>
      <form id="forgot-form" class="mt-4 space-y-4" action="#" onsubmit="return false;" data-endpoint="/password-reset">
        <div>
          <label for="forgot-email" class="sr-only">Correo electr√≥nico</label>
          <input id="forgot-email" name="email" type="email" required placeholder="tu@correo.com" class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 py-3 px-4 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-primary" />
        </div>
        <div class="flex items-center justify-between">
          <button id="forgot-submit" type="submit" class="inline-flex items-center rounded-lg bg-primary px-4 py-2 text-white hover:bg-primary/90">Enviar enlace</button>
          <button id="forgot-cancel" type="button" class="ml-2 text-sm text-gray-600 dark:text-gray-300 hover:underline">Cancelar</button>
        </div>
        <p id="forgot-feedback" class="text-sm mt-2"></p>
      </form>
    </div>
  </div>

  <script>
    // ========== REMEMBER-ME FUNCTIONALITY (Temporal - Solo para formulario) ==========
    function initRememberMe() {
      const STORAGE_KEY_EMAIL = 'weigence_temp_email';
      const STORAGE_KEY_PASSWORD = 'weigence_temp_password';
      const usuarioEl = document.getElementById('usuario');
      const passwordEl = document.getElementById('password');
      const rememberEl = document.getElementById('remember');

      if (!usuarioEl || !passwordEl || !rememberEl) {
        console.warn('[RememberMe] No se encontraron elementos necesarios');
        return;
      }

      // Cargar credenciales temporales guardadas (en la misma sesi√≥n del navegador)
      try {
        const tempEmail = sessionStorage.getItem(STORAGE_KEY_EMAIL);
        const tempPassword = sessionStorage.getItem(STORAGE_KEY_PASSWORD);
        if (tempEmail) {
          usuarioEl.value = tempEmail;
          rememberEl.checked = true;
        }
        if (tempPassword) {
          passwordEl.value = tempPassword;
        }
        console.log('[RememberMe] Credenciales temporales restauradas');
      } catch (e) {
        console.warn('[RememberMe] No hay credenciales temporales');
      }

      // Guardar credenciales temporales cuando se marca "Recordarme"
      rememberEl.addEventListener('change', function () {
        try {
          if (this.checked) {
            if (usuarioEl.value) sessionStorage.setItem(STORAGE_KEY_EMAIL, usuarioEl.value);
            if (passwordEl.value) sessionStorage.setItem(STORAGE_KEY_PASSWORD, passwordEl.value);
            console.log('[RememberMe] Credenciales temporales guardadas');
          } else {
            sessionStorage.removeItem(STORAGE_KEY_EMAIL);
            sessionStorage.removeItem(STORAGE_KEY_PASSWORD);
            console.log('[RememberMe] Credenciales temporales eliminadas');
          }
        } catch (e) {
          console.warn('[RememberMe] Error con sessionStorage:', e);
        }
      });

      // Actualizar credenciales temporales mientras se escriben (si "Recordarme" est√° marcado)
      usuarioEl.addEventListener('input', function () {
        if (rememberEl.checked) {
          try {
            sessionStorage.setItem(STORAGE_KEY_EMAIL, this.value);
          } catch (e) {
            console.warn(e);
          }
        }
      });

      passwordEl.addEventListener('input', function () {
        if (rememberEl.checked) {
          try {
            sessionStorage.setItem(STORAGE_KEY_PASSWORD, this.value);
          } catch (e) {
            console.warn(e);
          }
        }
      });

      console.log('[RememberMe] Inicializaci√≥n completada (Temporal)');
    }

    // Ejecutar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initRememberMe);
    } else {
      initRememberMe();
    }

    // ========== FORGOT PASSWORD MODAL FUNCTIONALITY ==========
    (function initForgotPassword() {
      const forgotLink = document.getElementById('forgot-link');
      const forgotModal = document.getElementById('forgot-modal');
      const forgotOverlay = document.getElementById('forgot-overlay');
      const forgotCancel = document.getElementById('forgot-cancel');
      const forgotForm = document.getElementById('forgot-form');
      const forgotEmail = document.getElementById('forgot-email');
      const forgotSubmit = document.getElementById('forgot-submit');
      const forgotFeedback = document.getElementById('forgot-feedback');

      function openModal() {
        if (forgotModal) {
          forgotModal.classList.remove('hidden');
          forgotModal.classList.add('flex');
          setTimeout(() => forgotEmail && forgotEmail.focus(), 50);
          console.log('[ForgotPassword] Modal abierto');
        }
      }
      function closeModal() {
        if (forgotModal) {
          forgotModal.classList.add('hidden');
          forgotModal.classList.remove('flex');
          if (forgotFeedback) { forgotFeedback.textContent = ''; forgotFeedback.className = 'text-sm mt-2'; }
          if (forgotForm) forgotForm.reset();
          console.log('[ForgotPassword] Modal cerrado');
        }
      }

      // Abrir modal al hacer clic en "¬øOlvidaste tu contrase√±a?"
      if (forgotLink) {
        forgotLink.addEventListener('click', function (ev) {
          ev.preventDefault();
          openModal();
        });
      }

      // Cerrar modal al hacer clic en el overlay
      if (forgotOverlay) {
        forgotOverlay.addEventListener('click', closeModal);
      }

      // Cerrar modal al hacer clic en "Cancelar"
      if (forgotCancel) {
        forgotCancel.addEventListener('click', closeModal);
      }

      // Cerrar modal al presionar Escape
      document.addEventListener('keydown', function (ev) {
        if (ev.key === 'Escape' && forgotModal && !forgotModal.classList.contains('hidden')) {
          closeModal();
        }
      });

      function isValidEmail(email) {
        return /\S+@\S+\.\S+/.test(email);
      }

      // Manejar env√≠o del formulario de recuperaci√≥n
      if (forgotForm) {
        forgotForm.addEventListener('submit', async function (ev) {
          ev.preventDefault();
          const email = forgotEmail && forgotEmail.value ? forgotEmail.value.trim() : '';

          // Validar email
          if (!email || !isValidEmail(email)) {
            if (forgotFeedback) {
              forgotFeedback.textContent = 'Por favor introduce un correo v√°lido.';
              forgotFeedback.className = 'text-sm text-red-600 dark:text-red-400';
            }
            return;
          }

          const endpoint = forgotForm.dataset.endpoint || '/password-reset';
          console.log('[ForgotPassword] üì§ Enviando solicitud a:', endpoint);
          console.log('[ForgotPassword] üìß Email:', email);
          
          // Obtener el token CSRF del meta tag o del formulario de login
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') 
                         || document.querySelector('input[name="csrf_token"]')?.value;
          console.log('[ForgotPassword] üîê CSRF Token:', csrfToken ? 'Encontrado' : 'NO ENCONTRADO');
          
          if (forgotSubmit) { forgotSubmit.disabled = true; forgotSubmit.textContent = 'Enviando...'; }
          if (forgotFeedback) forgotFeedback.textContent = '';

          try {
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken) {
              headers['X-CSRFToken'] = csrfToken;
              console.log('[ForgotPassword] ‚úÖ Token CSRF agregado a headers');
            }
            
            const res = await fetch(endpoint, {
              method: 'POST',
              headers: headers,
              body: JSON.stringify({ email })
            });

            console.log('[ForgotPassword] üì• Respuesta recibida - Status:', res.status);

            if (res.ok) {
              const jsonResponse = await res.json();
              console.log('[ForgotPassword] ‚úÖ Respuesta exitosa:', jsonResponse);
              
              if (forgotFeedback) {
                forgotFeedback.textContent = '‚úÖ Solicitud enviada. Si el correo existe en nuestro sistema, recibir√°s un enlace de recuperaci√≥n. Por favor revisa tu bandeja de entrada y spam.';
                forgotFeedback.className = 'text-sm text-green-600 dark:text-green-400';
              }
              console.log('[ForgotPassword] Solicitud exitosa para:', email);
              
              // Mantener el modal abierto por 8 segundos para que el usuario lea el mensaje
              setTimeout(closeModal, 8000);
            } else {
              let txt = 'Ocurri√≥ un error al solicitar el restablecimiento.';
              let errorDetail = null;
              
              try {
                const j = await res.json();
                console.error('[ForgotPassword] ‚ùå Error JSON del servidor:', j);
                if (j && j.message) txt = j.message;
                errorDetail = j;
              } catch (parseError) {
                console.error('[ForgotPassword] ‚ùå No se pudo parsear JSON de error:', parseError);
                try {
                  const textError = await res.text();
                  console.error('[ForgotPassword] ‚ùå Respuesta como texto:', textError);
                } catch (_) {}
              }
              
              if (forgotFeedback) {
                forgotFeedback.textContent = txt;
                forgotFeedback.className = 'text-sm text-red-600 dark:text-red-400';
              }
              console.error('[ForgotPassword] Error en servidor:', res.status, errorDetail);
            }
          } catch (err) {
            console.error('[ForgotPassword] ‚ùå Error de conexi√≥n COMPLETO:', err);
            console.error('[ForgotPassword] Stack trace:', err.stack);
            if (forgotFeedback) {
              forgotFeedback.textContent = 'Error de conexi√≥n. Intenta nuevamente.';
              forgotFeedback.className = 'text-sm text-yellow-700 dark:text-yellow-400';
            }
          } finally {
            if (forgotSubmit) { forgotSubmit.disabled = false; forgotSubmit.textContent = 'Enviar enlace'; }
          }
        });
      }
    })();

    // ========== TOGGLE PASSWORD VISIBILITY ==========
    (function initTogglePassword() {
      const passwordInput = document.getElementById('password');
      const toggleBtn = document.getElementById('toggle-password');
      const toggleIcon = toggleBtn.querySelector('.material-symbols-outlined');

      if (!passwordInput || !toggleBtn) {
        console.warn('[TogglePassword] No se encontraron elementos necesarios');
        return;
      }

      // Estado inicial
      let isPasswordVisible = false;

      // Funci√≥n para mostrar/ocultar el bot√≥n seg√∫n hay texto
      function updateButtonVisibility() {
        if (passwordInput.value.trim() === '') {
          toggleBtn.classList.add('hidden');
          console.log('[TogglePassword] Bot√≥n oculto (campo vac√≠o)');
        } else {
          toggleBtn.classList.remove('hidden');
          console.log('[TogglePassword] Bot√≥n visible (hay texto)');
        }
      }

      // Escuchar cambios en el input
      passwordInput.addEventListener('input', updateButtonVisibility);
      passwordInput.addEventListener('change', updateButtonVisibility);

      // Escuchar el toggle del bot√≥n
      toggleBtn.addEventListener('click', function (e) {
        e.preventDefault();
        
        // Toggle entre password y text
        if (isPasswordVisible) {
          passwordInput.type = 'password';
          toggleIcon.textContent = 'visibility';
          toggleIcon.classList.remove('text-primary');
          isPasswordVisible = false;
          console.log('[TogglePassword] Contrase√±a oculta');
        } else {
          passwordInput.type = 'text';
          toggleIcon.textContent = 'visibility_off';
          toggleIcon.classList.add('text-primary');
          isPasswordVisible = true;
          console.log('[TogglePassword] Contrase√±a visible');
        }
        
        // Mantener el foco en el input
        passwordInput.focus();
      });

      // Verificar estado inicial
      updateButtonVisibility();

      console.log('[TogglePassword] Inicializaci√≥n completada');
    })();
  </script>
</body>
</html>
