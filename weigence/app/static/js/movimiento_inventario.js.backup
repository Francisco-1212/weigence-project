document.addEventListener("DOMContentLoaded", async () => {
  const detalle = document.getElementById("detalle-contextual");
  const contenedor = document.getElementById("timeline-container");
  const cerrarBtn = document.getElementById("cerrar-detalle");
  let movimientos = Array.isArray(window.MOVIMIENTOS) ? window.MOVIMIENTOS : [];
  let pinnedMovimiento = null;

  console.log("Movimientos cargados:", movimientos);

  const fTipo = document.getElementById("filter-type");
  const fUser = document.getElementById("filter-user");
  const fLoc = document.getElementById("filter-location");
  const fDate = document.getElementById("filter-date");

  // Leer par√°metro id de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const movimientoId = urlParams.get('id');

  console.log("Elementos DOM encontrados:", { // Log 2: Verificar elementos DOM
    detalle: !!detalle,
    contenedor: !!contenedor,
    cerrarBtn: !!cerrarBtn,
    fTipo: !!fTipo,
    fUser: !!fUser,
    fLoc: !!fLoc,
    fDate: !!fDate
  });

  if (!detalle || !contenedor) {
    console.error("Elementos requeridos no encontrados");
    return;
  }

  // Funci√≥n para mostrar notificaciones toast
  function mostrarToast(mensaje, tipo = 'info') {
    const colores = {
      success: 'bg-green-500',
      error: 'bg-red-500',
      warning: 'bg-yellow-500',
      info: 'bg-blue-500'
    };

    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 ${colores[tipo]} text-white px-6 py-3 rounded-lg shadow-lg z-[100] animate-slideInRight`;
    toast.textContent = mensaje;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideOutRight 0.3s ease-out';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // Funci√≥n para cargar movimiento desde historial
  async function cargarMovimientoPinned(id) {
    try {
      const response = await fetch(`/api/movimientos/${id}`);
      const data = await response.json();
      
      if (data.success && data.movimiento) {
        pinnedMovimiento = data.movimiento;
        renderizarMovimientos();
        seleccionarMovimiento(pinnedMovimiento, true);
        return true;
      } else {
        console.error('Movimiento no encontrado:', data.error);
        mostrarToast('Movimiento no encontrado', 'error');
        return false;
      }
    } catch (error) {
      console.error('Error al cargar movimiento:', error);
      mostrarToast('Error al cargar el movimiento', 'error');
      return false;
    }
  }

  // Funci√≥n para remover movimiento pinned
  function removerPinned() {
    pinnedMovimiento = null;
    // Limpiar URL sin recargar
    const url = new URL(window.location);
    url.searchParams.delete('id');
    window.history.replaceState({}, '', url);
    renderizarMovimientos();
  }

  // Funci√≥n de renderizado completa
  function renderizarMovimientos() {
    console.log("Renderizando movimientos:", {
      cantidadMovimientos: movimientos.length,
      tienePinned: !!pinnedMovimiento
    });

    let html = '';

    // Renderizar movimiento pinned si existe
    if (pinnedMovimiento) {
      const m = pinnedMovimiento;
      const color = m.tipo_evento === "A√±adir" ? "green"
                  : m.tipo_evento === "Retirar" ? "red" : "blue";

      html += `
        <div class="pinned-item relative mb-6 cursor-pointer group animate-slideIn"
             data-pinned="true"
             data-tipo="${m.tipo_evento}" 
             data-user="${(m.usuario_nombre || '').toLowerCase()}">
          <div class="relative p-5 rounded-xl border-2 border-primary-400 dark:border-primary-600 bg-gradient-to-br from-primary-50 to-white dark:from-primary-950/30 dark:to-gray-900 shadow-lg">
            <!-- Badge Pinned -->
            <div class="absolute -top-3 left-4 px-3 py-1 bg-primary-500 text-white text-xs font-bold rounded-full shadow-sm flex items-center gap-1">
              <span class="material-symbols-outlined text-sm">push_pin</span>
              Desde Historial
            </div>
            
            <!-- Bot√≥n cerrar -->
            <button onclick="event.stopPropagation(); removerPinned()" 
                    class="absolute -top-3 -right-3 w-7 h-7 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-110"
                    title="Quitar de la vista">
              <span class="material-symbols-outlined text-sm">close</span>
            </button>

            <div class="flex items-start justify-between mt-2">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <div class="w-3 h-3 rounded-full bg-${color}-500 ring-2 ring-${color}-200 dark:ring-${color}-800"></div>
                  <p class="text-base font-bold text-gray-900 dark:text-white">
                    ${m.tipo_evento === "A√±adir" ? "‚ûï" :
                      m.tipo_evento === "Retirar" ? "‚ûñ" : "‚ü≥"} ${m.producto}
                  </p>
                </div>
                <div class="flex flex-wrap gap-3 text-xs text-gray-600 dark:text-gray-400">
                  <span class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">location_on</span>
                    ${m.ubicacion}
                  </span>
                  <span class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">person</span>
                    ${m.usuario_nombre}
                  </span>
                  <span class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">schedule</span>
                    ${m.timestamp}
                  </span>
                </div>
              </div>
              <div class="text-right ml-4">
                <p class="text-lg font-bold ${
                  m.tipo_evento === "A√±adir" ? "text-green-600 dark:text-green-400"
                  : m.tipo_evento === "Retirar" ? "text-red-600 dark:text-red-400"
                  : "text-blue-600 dark:text-blue-400"
                }">
                  ${m.tipo_evento === "A√±adir" ? "+" : m.tipo_evento === "Retirar" ? "-" : ""}${m.cantidad}kg
                </p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Mostrar solo los 7 m√°s recientes
    const lista = movimientos.length > 7 ? movimientos.slice(0, 7) : movimientos;

    html += lista.map((m, i) => {
  const color = m.tipo_evento === "A√±adir" ? "green"
              : m.tipo_evento === "Retirar" ? "red" : "blue";

  return `
    <div class="timeline-item relative pl-8 mb-4 cursor-pointer group"
         data-index="${i}" 
         data-tipo="${m.tipo_evento}" 
         data-user="${(m.usuario_nombre || '').toLowerCase()}"
         draggable="true">
      <div class="absolute left-0 top-4 w-4 h-4 rounded-full bg-${color}-500 ring-4 ring-[var(--card-bg-light)] dark:ring-[var(--card-bg-dark)]"></div>
      <div class="ml-4 p-4 rounded-xl border border-neutral-300 dark:border-[var(--border-dark)] bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] shadow-sm hover:border-primary-400 transition">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-sm font-bold text-[var(--text-light)] dark:text-[var(--text-dark)]">
              ${m.tipo_evento === "A√±adir" ? "‚ûï" :
                m.tipo_evento === "Retirar" ? "‚ûñ" : "‚ü≥"} ${m.producto}
            </p>
            <p class="text-xs text-neutral-600 dark:text-neutral-400 mt-1">
              ${m.ubicacion} ‚Ä¢ ${m.usuario_nombre}
            </p>
          </div>
          <div class="text-right">
            <p class="text-sm font-bold ${
              m.tipo_evento === "A√±adir" ? "text-green-600"
              : m.tipo_evento === "Retirar" ? "text-red-500"
              : "text-blue-500"
            }">
              ${m.tipo_evento === "A√±adir" ? "+" : m.tipo_evento === "Retirar" ? "-" : ""}${m.cantidad}kg
            </p>
            <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">
              ${(m.timestamp || "").split(" ")[1]?.slice(0,5) || ""}
            </p>
          </div>
        </div>
      </div>
    </div>
  `;
}).join("");

    // Agregar bot√≥n de historial si hay m√°s de 7
    if (movimientos.length > 7) {
      html += `
        <div class="flex justify-center mt-4">
          <button class="btn-show-history text-sm text-primary-500 dark:text-primary-400 hover:underline underline-offset-2 focus:outline-none">
            Ver historial completo (${movimientos.length} registros)
          </button>
        </div>
      `;
    }

    contenedor.innerHTML = html;

    // Reatacha el listener global para nuevos botones
    document.querySelectorAll(".btn-show-history").forEach(btn => {
      btn.onclick = (e) => {
        e.preventDefault();
        openHistorialModal();
      };
    });

    console.log("HTML generado, pinned:", !!pinnedMovimiento);
  }

  // Funci√≥n auxiliar para crear bloques de informaci√≥n
  function info(label, value) {
    return `
      <div class="bg-neutral-100 dark:bg-[var(--card-bg-dark)] border border-neutral-300 dark:border-[var(--border-dark)] rounded-lg p-3">
        <p class="text-[11px] text-neutral-600 dark:text-[var(--text-muted-dark)] uppercase tracking-wide">${label}</p>
        <p class="text-[14px] font-semibold text-[var(--text-light)] dark:text-white mt-1">${value || "‚Äî"}</p>
      </div>
    `;
  }

  // Funci√≥n para seleccionar y mostrar detalles de movimiento
  function seleccionarMovimiento(m, isPinned = false) {
    // Remover selecci√≥n previa de todos los items
    document.querySelectorAll('.timeline-item').forEach(item => {
      item.classList.remove('item-activo', 'ring-2', 'ring-primary-400/50', 'ring-primary-500/60', 'selected', 'ring-gray-500/60');
    });

    // Marcar visualmente el item seleccionado si NO es pinned
    if (!isPinned) {
      const idx = movimientos.indexOf(m);
      const selectedItem = document.querySelector(`.timeline-item[data-index="${idx}"]`);
      if (selectedItem) {
        selectedItem.classList.add(
          'item-activo',
          'ring-2',
          document.documentElement.classList.contains('dark')
            ? 'ring-gray-500/60'
            : 'ring-gray-500/60',
          'selected'
        );
      }
    }

    // Mostrar detalles usando la funci√≥n existente renderDetalle
    // Primero necesitamos encontrar el √≠ndice en el array de movimientos
    const idx = movimientos.indexOf(m);
    if (idx >= 0) {
      renderDetalle(idx);
    } else if (isPinned) {
      // Si es pinned, mostrar directamente
      renderDetalleDirecto(m);
    }
  }

  // Funci√≥n auxiliar para renderizar detalles de movimiento pinned
  function renderDetalleDirecto(m) {
    const tipo = {
      "A√±adir": { icon: "south", color: "text-green-600 bg-green-100 dark:text-green-400 dark:bg-green-900/40" },
      "Retirar": { icon: "north", color: "text-red-600 bg-red-100 dark:text-red-400 dark:bg-red-900/40" },
      "Mover": { icon: "sync_alt", color: "text-blue-600 bg-blue-100 dark:text-blue-400 dark:bg-blue-900/40" },
    }[m.tipo_evento] || { icon: "sync_alt", color: "text-blue-600 bg-blue-100 dark:text-blue-400 dark:bg-blue-900/40" };

    detalle.className = "min-h-[46vh] flex flex-col bg-[var(--card-bg-light)] dark:bg-[var(--card-sub-bg-dark)] border border-neutral-300 dark:border-[var(--border-dark)] rounded-lg p-5 space-y-5 overflow-auto";

    detalle.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 flex items-center justify-center rounded-md ${tipo.color}">
            <span class="material-symbols-outlined text-[20px]">${tipo.icon}</span>
          </div>
          <div>
            <h2 class="text-[15px] font-semibold text-[var(--text-light)] dark:text-white leading-tight">${m.producto}</h2>
            <p class="text-[11px] text-neutral-600 dark:text-[var(--text-muted-dark)]">${m.timestamp}</p>
          </div>
        </div>
        <span class="px-2 py-[2px] text-[11px] font-medium rounded border border-neutral-300 dark:border-[var(--border-dark)] text-primary-600 dark:text-primary-400 bg-neutral-100 dark:bg-[var(--card-bg-dark)]">
          ${m.tipo_evento}
        </span>
      </div>

      <div class="grid grid-cols-2 gap-3">
        ${info("Cantidad", `${m.cantidad} unidades`)}
        ${info("Ubicaci√≥n", m.ubicacion)}
        ${info("Usuario", m.usuario_nombre)}
        ${info("RUT", m.rut_usuario || "‚Äî")}
      </div>

      <div class="bg-neutral-100 dark:bg-[var(--card-bg-dark)] border border-neutral-300 dark:border-[var(--border-dark)] rounded-lg p-4">
        <p class="text-[11px] text-neutral-600 dark:text-[var(--text-muted-dark)] uppercase tracking-wide mb-1">Observaci√≥n</p>
        <p class="text-[13px] text-neutral-800 dark:text-neutral-200 leading-snug">${m.observacion || "Sin observaciones."}</p>
      </div>
    `;
    
    // Mostrar estad√≠sticas si hay idproducto
    const statsSection = document.getElementById('stats-producto');
    if (statsSection && m.idproducto) {
      statsSection.classList.remove('hidden');
      cargarEstadisticas(m.idproducto);
    }
  }

  // Renderizado inicial
  renderizarMovimientos();

  // Cargar movimiento desde historial si hay ID
  if (movimientoId) {
    // Verificar si ya est√° en los √∫ltimos 7
    const lista = movimientos.length > 7 ? movimientos.slice(0, 7) : movimientos;
    const encontrado = lista.find(m => m.id_movimiento == movimientoId);
    
    if (encontrado) {
      // Est√° en los √∫ltimos 7, seleccionarlo normalmente
      const idxLista = lista.indexOf(encontrado);
      const item = document.querySelector(`.timeline-item[data-index="${idxLista}"]`);
      if (item) {
        selectItem(item);
        const idxCompleto = movimientos.indexOf(encontrado);
        renderDetalle(idxCompleto);
      }
    } else {
      // No est√° en los √∫ltimos 7, cargar como pinned
      await cargarMovimientoPinned(movimientoId);
    }
  }

  // Exponer funci√≥n globalmente para el bot√≥n X
  window.removerPinned = removerPinned;

  // --- Click y Drag & Drop ---
  contenedor.addEventListener("click", (e) => {
    // Manejar clic en pinned
    const pinnedItem = e.target.closest(".pinned-item");
    if (pinnedItem && pinnedMovimiento) {
      seleccionarMovimiento(pinnedMovimiento, true);
      return;
    }

    // Manejar clic en timeline normal
    const item = e.target.closest(".timeline-item");
    if (!item) return;
    
    const idx = Number(item.dataset.index);
    const lista = movimientos.length > 7 ? movimientos.slice(0, 7) : movimientos;
    const m = lista[idx];
    
    if (m) {
      // Marcar visualmente
      selectItem(item);
      // Encontrar √≠ndice en array completo para renderDetalle
      const idxCompleto = movimientos.indexOf(m);
      renderDetalle(idxCompleto);
    }
  });

  contenedor.addEventListener("dragstart", (e) => {
    const item = e.target.closest(".timeline-item");
    if (!item) return;
    const img = new Image();
    img.src =
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAEklEQVR42mP8/5+hHgAHggJ/P6pHUgAAAABJRU5ErkJggg==";
    e.dataTransfer.setDragImage(img, 0, 0);
    e.dataTransfer.setData("text/plain", item.dataset.index);
    item.classList.add("dragging");
  });

  contenedor.addEventListener("dragend", (e) => {
    const item = e.target.closest(".timeline-item");
    if (item) item.classList.remove("dragging");
  });

  detalle.addEventListener("dragover", (e) => {
    e.preventDefault();
    detalle.classList.add("ring-2", "ring-primary-400/50");
  });
  detalle.addEventListener("dragleave", () => {
    detalle.classList.remove("ring-2", "ring-primary-400/50");
  });
  detalle.addEventListener("drop", (e) => {
    e.preventDefault();
    detalle.classList.remove("ring-2", "ring-primary-400/50");
    const i = Number(e.dataTransfer.getData("text/plain"));
    const lista = movimientos.length > 7 ? movimientos.slice(0, 7) : movimientos;
    const m = lista[i];
    
    if (m) {
      const el = contenedor.querySelector(`.timeline-item[data-index="${i}"]`);
      if (el) selectItem(el);
      
      // Encontrar √≠ndice en array completo
      const idxCompleto = movimientos.indexOf(m);
      renderDetalle(idxCompleto);
    }
  });

  if (cerrarBtn) cerrarBtn.addEventListener("click", resetDetalle);

  // --- Filtros din√°micos ---
  [fTipo, fUser].forEach((el) => el && el.addEventListener("input", applyFilters));
  function applyFilters() {
    const t = fTipo?.value || "";
    const u = (fUser?.value || "").trim().toLowerCase();

    contenedor.querySelectorAll(".timeline-item").forEach((it) => {
      const okTipo = !t || it.dataset.tipo === t;
      const okUser = !u || (it.dataset.user && it.dataset.user.toLowerCase().includes(u));
      it.classList.toggle("hidden", !(okTipo && okUser));
    });
  }

  // --- Selecci√≥n visual ---
  function selectItem(item) {
    contenedor.querySelectorAll(".timeline-item").forEach((el) => {
      el.classList.remove("item-activo", "ring-2", "ring-primary-400/50", "ring-primary-500/60", "selected");
    });

    item.classList.add(
      "item-activo",
      "ring-2",
      document.documentElement.classList.contains("dark")
        ? "ring-gray-500/60"
        : "ring-gray-500/60",
      "selected"
    );
  }


  // --- Render de detalle ---
  function renderDetalle(i) {
    const m = movimientos[i];
    if (!m) return;

    const tipo = {
      "A√±adir": { icon: "south", color: "text-green-600 bg-green-100 dark:text-green-400 dark:bg-green-900/40" },
      "Retirar": { icon: "north", color: "text-red-600 bg-red-100 dark:text-red-400 dark:bg-red-900/40" },
      "Mover": { icon: "sync_alt", color: "text-blue-600 bg-blue-100 dark:text-blue-400 dark:bg-blue-900/40" },
    }[m.tipo_evento] || { icon: "sync_alt", color: "text-blue-600 bg-blue-100 dark:text-blue-400 dark:bg-blue-900/40" };

    const relacionados = movimientos.filter(x => x.producto === m.producto).slice(0, 8);

    detalle.className = "min-h-[46vh] flex flex-col bg-[var(--card-bg-light)] dark:bg-[var(--card-sub-bg-dark)] border border-neutral-300 dark:border-[var(--border-dark)] rounded-lg p-5 space-y-5 overflow-auto";

    detalle.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 flex items-center justify-center rounded-md ${tipo.color}">
            <span class="material-symbols-outlined text-[20px]">${tipo.icon}</span>
          </div>
          <div>
            <h2 class="text-[15px] font-semibold text-[var(--text-light)] dark:text-white leading-tight">${m.producto}</h2>
            <p class="text-[11px] text-neutral-600 dark:text-[var(--text-muted-dark)]">${m.timestamp}</p>
          </div>
        </div>
        <span class="px-2 py-[2px] text-[11px] font-medium rounded border border-neutral-300 dark:border-[var(--border-dark)] text-primary-600 dark:text-primary-400 bg-neutral-100 dark:bg-[var(--card-bg-dark)]">
          ${m.tipo_evento}
        </span>
      </div>

        <div class="grid grid-cols-2 gap-3">
            ${info("Cantidad", `${m.cantidad} unidades`)}
            ${info("Ubicaci√≥n", m.ubicacion)}
            ${info("Usuario", m.usuario_nombre)}
            ${info("RUT", m.rut_usuario)}
        </div>

      <div class="bg-neutral-100 dark:bg-[var(--card-bg-dark)] border border-neutral-300 dark:border-[var(--border-dark)] rounded-lg p-4">
        <p class="text-[11px] text-neutral-600 dark:text-[var(--text-muted-dark)] uppercase tracking-wide mb-1">Observaci√≥n</p>
        <p class="text-[13px] text-neutral-800 dark:text-neutral-200 leading-snug">${m.observacion || "Sin observaciones."}</p>
      </div>

        <div>
            <p class="text-[13px] font-semibold text-[var(--text-light)] dark:text-white mb-2">Historial del producto</p>
            <div class="rounded-lg overflow-hidden border border-neutral-300 dark:border-[var(--border-dark)] divide-y divide-neutral-300 dark:divide-[var(--border-dark)]">
                ${relacionados.map(r => `
                    <div class="flex justify-between items-center px-3 py-2 bg-neutral-50 dark:bg-[var(--card-bg-dark)] hover:bg-neutral-100 dark:hover:bg-neutral-800/50 transition-colors">
                        <span class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-[14px] ${r.tipo_evento === "A√±adir" ? "text-green-600 dark:text-green-400" :
        r.tipo_evento === "Retirar" ? "text-red-600 dark:text-red-400" :
          "text-blue-600 dark:text-blue-400"
      }">${r.tipo_evento === "A√±adir" ? "south" :
        r.tipo_evento === "Retirar" ? "north" :
          "sync_alt"
      }</span>
                            ${r.tipo_evento} ‚Ä¢ ${r.cantidad} unidades ‚Ä¢ ${r.usuario_nombre}
                        </span>
                        <span class="text-[11px] text-neutral-600 dark:text-[var(--text-muted-dark)]">
                            ${String(r.timestamp).split(" ")[1]}
                        </span>
                    </div>
                `).join("")}
            </div>
        </div>
    `;
    
    // Mostrar secci√≥n de estad√≠sticas
    const statsSection = document.getElementById('stats-producto');
    if (statsSection) {
      statsSection.classList.remove('hidden');
    }
    
    // Cargar estad√≠sticas del producto
    if (m.idproducto) {
      cargarEstadisticas(m.idproducto);
    }
  }  function info(label, value) {
    return `
      <div class="bg-neutral-100 dark:bg-[var(--card-bg-dark)] border border-neutral-300 dark:border-[var(--border-dark)] rounded-lg p-3">
        <p class="text-[11px] text-neutral-600 dark:text-[var(--text-muted-dark)] uppercase tracking-wide">${label}</p>
        <p class="text-[14px] font-semibold text-[var(--text-light)] dark:text-white mt-1">${value || "‚Äî"}</p>
      </div>
    `;
  }

  function resetDetalle() {
    detalle.className = "min-h-[46vh] flex flex-col items-center justify-center border-2 border-dashed border-neutral-400/40 dark:border-[var(--border-dark)] rounded-lg text-center px-6 py-10";
    detalle.innerHTML = `
      <span class="material-symbols-outlined text-5xl text-neutral-400 dark:text-neutral-600">touch_app</span>
      <p class="mt-2 text-sm text-neutral-500">Selecciona o arrastra un movimiento para ver detalles</p>
      <p class="text-xs text-neutral-500">Historial, usuarios y observaciones aparecer√°n aqu√≠</p>
    `;
    
    // Ocultar estad√≠sticas
    const statsSection = document.getElementById('stats-producto');
    if (statsSection) {
      statsSection.classList.add('hidden');
    }
  }

  // --- Modal de Nuevo Movimiento ---
  const modal = document.getElementById("modal-new-mov");
  const btnNew = document.getElementById("btn-new-mov");
  const form = document.getElementById("form-new-mov");

  // Abrir modal
  btnNew?.addEventListener("click", () => {
    modal?.classList.remove("hidden");
    cargarProductos();
  });

  // Cerrar modal
  modal?.querySelectorAll(".close-modal").forEach(btn => {
    btn.addEventListener("click", () => modal.classList.add("hidden"));
  });

  // Evitar cierre al hacer click dentro del modal
  modal?.querySelector("div > div").addEventListener("click", e => e.stopPropagation());

  // Cerrar al hacer click fuera
  modal?.addEventListener("click", e => {
    if (e.target === modal) modal.classList.add("hidden");
  });

  // Funci√≥n para cargar productos
  function cargarProductos() {
    console.log("üì¶ Cargando productos...");
    fetch("/api/productos")
      .then(r => {
        console.log("üì° Respuesta recibida:", r.status);
        return r.json();
      })
      .then(productos => {
        console.log("‚úÖ Productos cargados:", productos);
        const selectProductos = form.querySelector("[name=idproducto]");
        if (!selectProductos) {
          console.error("‚ùå No se encontr√≥ el select de productos");
          return;
        }

        if (productos && productos.length > 0) {
          selectProductos.innerHTML = productos.map(p =>
            `<option value="${p.idproducto}">${p.nombre} (Stock: ${p.stock || 0} unidades)</option>`
          ).join("");
          console.log(`‚úÖ ${productos.length} productos agregados al select`);
        } else {
          selectProductos.innerHTML = '<option value="">No hay productos disponibles</option>';
          console.warn("‚ö†Ô∏è No hay productos en la base de datos");
        }
      })
      .catch(error => {
        console.error("‚ùå Error cargando productos:", error);
        mostrarError("Error al cargar los productos");
      });
  }

  // Agregar event listener para cambios en tipo de movimiento
  form?.querySelector("[name=tipo_evento]")?.addEventListener("change", cargarProductos);

  // Manejar env√≠o del formulario
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    try {
      const formData = new FormData(form);
      const datos = {};

      // Convertir y validar campos
      datos.tipo_evento = formData.get("tipo_evento");
      datos.idproducto = parseInt(formData.get("idproducto"));
      datos.cantidad = parseInt(formData.get("cantidad"));
      datos.observacion = formData.get("observacion") || "";

      // NO enviamos id_estante - se calcula autom√°ticamente en el backend

      // Validar campos num√©ricos
      if (isNaN(datos.idproducto) || isNaN(datos.cantidad)) {
        mostrarError("Los campos num√©ricos son inv√°lidos");
        return;
      }

      if (datos.cantidad <= 0) {
        mostrarError("La cantidad debe ser mayor a 0");
        return;
      }

      console.log("Enviando movimiento:", datos);

      const response = await fetch("/api/movimientos/nuevo", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(datos)
      });

      const result = await response.json();

      if (!response.ok || !result.success) {
        throw new Error(result.error || "Error al guardar el movimiento");
      }

      // √âxito
      mostrarExito(result.mensaje || "Movimiento registrado correctamente");
      modal?.classList.add("hidden");
      form.reset();

      // Recargar p√°gina despu√©s de un breve delay
      setTimeout(() => window.location.reload(), 800);

    } catch (error) {
      console.error("Error:", error);
      mostrarError(error.message);
    }
  });

  // Funciones de notificaci√≥n
  function mostrarError(mensaje) {
    // Crear notificaci√≥n toast
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 z-50 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-fadeIn';
    toast.innerHTML = `
      <span class="material-symbols-outlined">error</span>
      <span>${mensaje}</span>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  function mostrarExito(mensaje) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 z-50 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-fadeIn';
    toast.innerHTML = `
      <span class="material-symbols-outlined">check_circle</span>
      <span>${mensaje}</span>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  // Funci√≥n para cargar estad√≠sticas del producto
  async function cargarEstadisticas(idproducto) {
    try {
      const response = await fetch(`/api/movimientos/estadisticas/${idproducto}`);
      const data = await response.json();

      if (data.success) {
        // Actualizar las estad√≠sticas en la secci√≥n correspondiente
        actualizarEstadisticasUI(data);
      }
    } catch (error) {
      console.error("Error cargando estad√≠sticas:", error);
    }
  }

  function actualizarEstadisticasUI(stats) {
    const statsSection = document.getElementById('stats-container');
    if (!statsSection) return;

    statsSection.innerHTML = `
      <div class="p-3 rounded-lg border border-neutral-300 dark:border-[var(--border-dark)] bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] text-center animate-fadeIn">
        <p class="text-xs text-neutral-500 dark:text-neutral-400">Entradas</p>
        <p class="text-lg font-bold text-green-500">+${stats.entradas} unidades</p>
      </div>
      <div class="p-3 rounded-lg border border-neutral-300 dark:border-[var(--border-dark)] bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] text-center animate-fadeIn" style="animation-delay: 50ms">
        <p class="text-xs text-neutral-500 dark:text-neutral-400">Retiros</p>
        <p class="text-lg font-bold text-red-500">‚àí${stats.retiros} unidades</p>
      </div>
      <div class="p-3 rounded-lg border border-neutral-300 dark:border-[var(--border-dark)] bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] text-center animate-fadeIn" style="animation-delay: 100ms">
        <p class="text-xs text-neutral-500 dark:text-neutral-400">Stock Actual</p>
        <p class="text-lg font-bold text-blue-500">${stats.stock_actual} unidades</p>
      </div>
      <div class="p-3 rounded-lg border border-neutral-300 dark:border-[var(--border-dark)] bg-[var(--card-bg-light)] dark:bg-[var(--card-bg-dark)] text-center animate-fadeIn" style="animation-delay: 150ms">
        <p class="text-xs text-neutral-500 dark:text-neutral-400">√öltimo Movimiento</p>
        <p class="text-sm font-semibold text-[var(--text-light)] dark:text-[var(--text-dark)]">${stats.ultimo_movimiento}</p>
      </div>
    `;
  }

  // Hook vac√≠o para integraci√≥n futura con hardware
  function procesarEventoHardware(peso) {
    // TODO: Integraci√≥n con sensor de peso
    // Esta funci√≥n se llamar√° cuando el hardware detecte un cambio de peso
    console.log("Evento de hardware detectado:", peso);
    
    // Ejemplo de uso futuro:
    // const cantidadDetectada = calcularCantidadDesdePeso(peso);
    // autocompletarFormulario(cantidadDetectada);
  }

  // Exponer funciones para uso futuro
  window.procesarEventoHardware = procesarEventoHardware;
  window.mostrarToast = mostrarToast;

  // Agregar estilos de animaci√≥n
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    .animate-slideIn {
      animation: slideIn 0.3s ease-out;
    }
    .animate-slideInRight {
      animation: slideInRight 0.3s ease-out;
    }
  `;
  document.head.appendChild(style);

  // --- Estado inicial ---
  resetDetalle();
  applyFilters();
});

});
