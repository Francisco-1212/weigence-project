{% extends "base.html" %}

{% block title %}Alertas - Weigence{% endblock %}

{% block contenido %}
<h2 style="text-align:center; margin-top: 20px;">
    Alertas Activas: 
    <span style="color: #dc2626; font-weight: bold;">{{ alertas_activas }}</span>
</h2>

<div style="margin-bottom: 20px; text-align: right;">
    <label for="filtro-revisadas"><strong>Filtrar:</strong></label>
    <select id="filtro-revisadas" onchange="filtrarAlertas()">
        <option value="todas">Todas las alertas</option>
        <option value="no-revisadas" selected>Solo no revisadas</option>
        <option value="revisadas">Solo revisadas</option>
    </select>
</div>

{% if registros %}
<table id="tabla-alertas">
    <thead>
        <tr>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Estante</th>
            <th>Peso (g)</th>
            <th>Gravedad</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for r in registros %}
        <tr class="alerta-true" data-gravedad="{{ r.gravedad }}" data-estado="{{ r.estado }}">
            <td>
                <span class="tipo-alerta tipo-{{ r.tipo_alerta }}">
                    {% if r.tipo_alerta == 'bajo_stock' %}
                        üìâ Bajo Stock
                    {% elif r.tipo_alerta == 'sobrepeso' %}
                        ‚öñÔ∏è Sobrepeso
                    {% elif r.tipo_alerta == 'peso_anormal' %}
                        ‚ö†Ô∏è Peso Anormal
                    {% else %}
                        üîî {{ r.tipo_alerta.title() }}
                    {% endif %}
                </span>
            </td>
            <td>{{ r.producto }}</td>
            <td>{{ r.estante }}</td>
            <td>{{ r.peso }}</td>
            <td>
                <span class="gravedad gravedad-{{ r.gravedad }}">
                    {% if r.gravedad == 'alta' %}
                        üî¥ Alta
                    {% elif r.gravedad == 'media' %}
                        üü° Media
                    {% elif r.gravedad == 'baja' %}
                        üü¢ Baja
                    {% else %}
                        ‚ö™ {{ r.gravedad.title() }}
                    {% endif %}
                </span>
            </td>
            <td>{{ r.fecha_creacion }}</td>
            <td>
                <span class="estado-{{ r.estado }}">
                    {{ "‚úÖ Revisada" if r.revisada else "‚ùå Pendiente" }}
                </span>
            </td>
            <td>
                <button class="accion ver" onclick="mostrarModalAlerta('{{ r.titulo }}', '{{ r.descripcion }}', '{{ r.peso }}', '{{ r.fecha_creacion }}', '{{ r.estante }}', '{{ r.producto }}')">
                    <i class="fas fa-eye"></i>
                </button>
                {% if not r.revisada %}
                <button class="accion revisar" onclick="marcarRevisada(this)">
                    ‚úîÔ∏è Revisar
                </button>
                {% else %}
                <button class="accion revisada" disabled>
                    ‚úîÔ∏è Revisada
                </button>
                {% endif %}
                <button class="accion eliminar" onclick="eliminarFila(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div style="text-align: center; padding: 50px; color: #666;">
    <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
    <h3>No hay alertas registradas</h3>
    <p>Cuando se detecten anomal√≠as en los pesajes, aparecer√°n aqu√≠.</p>
</div>
{% endif %}

<!-- Modal para detalles de alerta -->
<div id="modal-alerta" class="modal">
    <div class="modal-contenido" style="max-width: 500px;">
        <span class="cerrar" onclick="cerrarModalAlerta()">&times;</span>
        <h3>üìã Detalle de la Alerta</h3>
        
        <div style="margin: 15px 0;">
            <strong>T√≠tulo:</strong>
            <p id="modal-titulo" style="margin: 5px 0; font-weight: normal;"></p>
        </div>
        
        <div style="margin: 15px 0;">
            <strong>Descripci√≥n:</strong>
            <p id="modal-descripcion" style="margin: 5px 0; font-weight: normal; color: #555;"></p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
            <div>
                <strong>Peso:</strong>
                <p id="modal-peso-detalle" style="margin: 5px 0; font-weight: normal;"></p>
            </div>
            <div>
                <strong>Fecha:</strong>
                <p id="modal-fecha-detalle" style="margin: 5px 0; font-weight: normal;"></p>
            </div>
            <div>
                <strong>Estante:</strong>
                <p id="modal-estante" style="margin: 5px 0; font-weight: normal;"></p>
            </div>
            <div>
                <strong>Producto:</strong>
                <p id="modal-producto" style="margin: 5px 0; font-weight: normal;"></p>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="cerrarModalAlerta()" style="background: #3b82f6; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer;">
                Cerrar
            </button>
        </div>
    </div>
</div>

<script>
function mostrarModalAlerta(titulo, descripcion, peso, fecha, estante, producto) {
    document.getElementById("modal-titulo").innerText = titulo;
    document.getElementById("modal-descripcion").innerText = descripcion;
    document.getElementById("modal-peso-detalle").innerText = peso + "g";
    document.getElementById("modal-fecha-detalle").innerText = fecha;
    document.getElementById("modal-estante").innerText = estante;
    document.getElementById("modal-producto").innerText = producto;
    document.getElementById("modal-alerta").style.display = "block";
}

function cerrarModalAlerta() {
    document.getElementById("modal-alerta").style.display = "none";
}
</script>

<style>
.tipo-alerta {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: bold;
}

.tipo-bajo_stock {
    background-color: #fef3c7;
    color: #92400e;
}

.tipo-sobrepeso {
    background-color: #fecaca;
    color: #991b1b;
}

.tipo-peso_anormal {
    background-color: #e0e7ff;
    color: #3730a3;
}

.gravedad {
    padding: 3px 6px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: bold;
}

.gravedad-alta {
    background-color: #fecaca;
    color: #991b1b;
}

.gravedad-media {
    background-color: #fef3c7;
    color: #92400e;
}

.gravedad-baja {
    background-color: #d1fae5;
    color: #065f46;
}

.estado-activa {
    color: #dc2626;
    font-weight: bold;
}

.estado-revisada {
    color: #16a34a;
    font-weight: bold;
}
</style>

{% endblock %}