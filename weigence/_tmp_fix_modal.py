from pathlib import Path
p = Path(r"app/static/js/modules/audit-render.js")
data = p.read_text(encoding="utf-8")
start = data.index("export function mostrarDetallesLog")
end = data.index("export function updateStats", start)
new_block = """export function mostrarDetallesLog(log) {\n  const overlay = ensureDetailModal();\n  const fecha = overlay.querySelector('[data-fecha]');\n  const tipo = overlay.querySelector('[data-tipo]');\n  const nivel = overlay.querySelector('[data-nivel]');\n  const usuario = overlay.querySelector('[data-usuario]');\n  const producto = overlay.querySelector('[data-producto]');\n  const estante = overlay.querySelector('[data-estante]');\n  const detalle = overlay.querySelector('[data-detalle]');\n  const chip = overlay.querySelector('[data-detail-chip]');\n  const rowProducto = overlay.querySelector('[data-row-producto]');\n  const rowEstante = overlay.querySelector('[data-row-estante]');\n\n  const esc = (v) => (v == null ? '' : String(v));\n  const severidad = (log.nivel || 'INFO').toLowerCase();\n\n  if (fecha) fecha.textContent = `${esc(log.hora)} - ${esc(log.fecha)}`;\n  if (tipo) tipo.textContent = esc(log.tipo_evento || 'evento');\n  if (nivel) nivel.textContent = esc(log.nivel || 'INFO');\n  if (usuario) usuario.textContent = `${esc(log.usuario || 'Sistema')}${log.rut && log.rut !== 'N/A' ? ` (${esc(log.rut)})` : ''}`;\n\n  const hasProd = Boolean(log.producto);\n  const hasEst = Boolean(log.estante);\n  if (rowProducto) rowProducto.style.display = hasProd ? '' : 'none';\n  if (rowEstante) rowEstante.style.display = hasEst ? '' : 'none';\n  if (hasProd && producto) producto.textContent = esc(log.producto);\n  if (hasEst && estante) estante.textContent = esc(log.estante);\n\n  if (detalle) {\n    detalle.textContent = esc(log.detalle || log.mensaje || 'Sin detalles adicionales.');\n  }\n\n  if (chip) {\n    chip.textContent = esc(log.nivel || 'INFO');\n    chip.classList.remove('warning', 'critical');\n    if (severidad.startsWith('warn')) chip.classList.add('warning');\n    if (severidad.startsWith('crit') || severidad.startsWith('err')) chip.classList.add('critical');\n  }\n\n  overlay.classList.add('is-visible');\n}\n\n"""
p.write_text(data[:start] + new_block + data[end:], encoding="utf-8")
